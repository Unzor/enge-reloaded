(e=>{"use strict";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={};t.split("").forEach((e,t)=>r[e]=t),r["="]=0,e.Base64={decode:e=>{var t=e.length,s=t/4*3;"="===e[t-2]&&--s,"="===e[t-1]&&--s;let a=new ArrayBuffer(s),i=new Uint8Array(a),n=0;for(let s=0;s<t;s+=4){const t=r[e[s+0]]<<18|r[e[s+1]]<<12|r[e[s+2]]<<6|r[e[s+3]];i[n+0]=t>>16&255,i[n+1]=t>>8&255,i[n+2]=t>>0&255,n+=3}return a},encode:e=>{for(var r,s="",a=new Uint8Array(e),i=a.byteLength,n=i%3,c=i-n,o=0;o<c;o+=3)r=a[o]<<16|a[o+1]<<8|a[o+2],s+=t[r>>18&63]+t[r>>12&63]+t[r>>6&63]+t[r>>0&63];return 1==n?(r=a[c],s+=t[(252&r)>>2]+t[(3&r)<<4]+"=="):2==n&&(r=a[c]<<8|a[c+1],s+=t[(64512&r)>>10]+t[(1008&r)>>4]+t[(15&r)<<2]+"="),s}}})(window),(e=>{"use strict";const t=/[A-Za-z]{4}_[0-9]{3}\.[0-9]{2}/;let r="",s=null,a="";function i(e){r+=String.fromCharCode(e),10!==e&&13!==e||(r!==s&&(!function(){const e=t.exec(r);if(e){let t=e[0].replace(".","").toUpperCase();a!==t&&(console.warn(`gamecode: '${t}'`),a=t)}}(),s=r),console.debug(r),r="")}e.trace=function(e,t){switch(e){case 160:switch(t){case 60:i(cpu.gpr[4])}break;case 176:switch(t){case 61:i(cpu.gpr[4])}}}})(window),(e=>{"use strict";e.log=function(){console.log.call(console,("000000000000"+psx.clock).substr(-12)+"]",Array.prototype.slice.call(arguments).join(""))},e.hex=function(e,t){return("00000000"+(e>>>0).toString(16)).substr(-(t||8))},e.readStorageStream=function(e,t){const r=localStorage.getItem(e);if(r)return t(Base64.decode(r));return t(null)},e.writeStorageStream=function(e,t){const r=Base64.encode(t);localStorage.setItem(e,r)}})(window),(e=>{"use strict";var t=function(e){return 16*Math.floor(e/10)+Math.floor(e%10)},r=function(e){return 10*Math.floor(e/16)+Math.floor(e%16)};let s=new Int8Array(0),a=new Int16Array(0),i=new Int32Array(0);var n={cdImage:new Uint32Array(0),cdRomFile:void 0,currLoc:0,filter:{},hasCdFile:!1,irq:0,irqEnable:255,mode:0,ncmdctrl:0,ncmdread:0,params:new Array(16),pcm:new Float32Array(18816),pcmidx:0,pcmmax:0,results:new Array(16),sectorEnd:0,sectorIndex:0,sectorOffset:0,sectorSize:0,seekLoc:0,currTrack:{},status:24,statusCode:0,xa:new Float32Array(8064),playIndex:0,lastCommand:0,tracks:[],volCdLeft2SpuLeft:1,volCdLeft2SpuRight:0,volCdRight2SpuLeft:0,volCdRight2SpuRight:1,config:{volCdLeft2SpuLeft:1,volCdLeft2SpuRight:0,volCdRight2SpuLeft:0,volCdRight2SpuRight:1},mute:!1,rd08r1800:function(){return n.status},rd08r1801:function(){return 33==(35&n.status)?(1===n.results.length&&(n.status&=-65,n.status&=-33),n.results.shift()):0},rd08r1802:function(){return 64&n.status?n.cdImage.getInt8(n.sectorOffset+n.sectorIndex++):0},rd08r1803:function(){switch(3&n.status){case 0:return 224|n.irqEnable;case 1:return n.irq;default:abort("unimplemented index mode:"+(3&n.status))}},wr08r1800:function(e){n.status=-4&n.status|3&e},wr08r1801:function(e){switch(3&n.status){case 0:n.command(e);break;case 3:n.config.volCdRight2SpuRight=((255&e)>>>0)/128;break;default:abort("unimplemented index mode:"+(3&n.status))}},wr08r1802:function(e){switch(3&n.status){case 0:n.params.push(e),16===n.params.length&&(n.status&=-17);break;case 1:n.irqEnable=e,n.irq=0;break;case 2:n.config.volCdLeft2SpuLeft=((255&e)>>>0)/128;break;case 3:n.config.volCdRight2SpuLeft=((255&e)>>>0)/128;break;default:abort("unimplemented index mode:"+(3&n.status))}},wr08r1803:function(e){switch(3&n.status){case 0:128===e&&(n.status|=64);break;case 1:31&e&n.irqEnable&&n.acknowledgeInterrupt(e),64&e&&n.resetparams();break;case 2:n.config.volCdLeft2SpuRight=((255&e)>>>0)/128;break;case 3:32&e&&(n.volCdLeft2SpuLeft=n.config.volCdLeft2SpuLeft,n.volCdLeft2SpuRight=n.config.volCdLeft2SpuRight,n.volCdRight2SpuLeft=n.config.volCdRight2SpuLeft,n.volCdRight2SpuRight=n.config.volCdRight2SpuRight);break;default:abort("unimplemented index mode:"+(3&n.status))}},acknowledgeInterrupt:function(e){n.irq&=~(31&e&n.irqEnable)},resetparams:function(){n.params.length=0},command:function(e){let t=512;switch(n.setIrq(0),n.results.length=0,n.status|=128,n.ncmdctrl=e,e){case 1:t=50401;break;case 3:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 19:case 20:case 25:case 26:case 30:break;case 10:t=81102;case 2:case 6:case 7:case 8:case 21:case 22:case 27:case 9:n.stopReading();break;case 153:break;default:abort("unimplemented command: $"+hex(e,2))}psx.setEvent(this.eventCmd,t>>>0)},setIrq:function(e){n.irq=224&n.irq|31&e,31&n.irq&n.irqEnable&&(cpu.istat|=4)},enqueueEvent:function(e,...t){this.results.length&&abort("not yet read all results"),this.results.push(t),this.status&=-129,this.status|=32,this.setIrq(e)},eventCmd:null,completeCmd:function(e,s){if(psx.unsetEvent(e),31&n.irq)return void psx.setEvent(this.eventCmd,64);const a=PSX_SPEED/(128&n.mode?150:75);var i=n.ncmdctrl;switch(n.ncmdctrl=0,i){case 0:break;case 1:n.hasCdFile?this.enqueueEvent(3,2):this.enqueueEvent(5,1);break;case 2:0!==n.params[0]||0!==n.params[1]||0!==n.params[2]?n.seekLoc=4500*r(n.params[0])+75*r(n.params[1])+r(n.params[2]):n.seekLoc=n.currLoc,this.enqueueEvent(3,2);break;case 3:0!==n.params.length&&0!==n.params[0]||(n.currLoc=n.seekLoc),1===n.params.length&&(n.currTrack=n.tracks[r(n.params[0])],n.currLoc=n.seekLoc=n.currTrack.begin+150,console.log(`CdlPlay: ${r(n.params[0])} : ${n.currLoc}`)),psx.setEvent(this.eventRead,a>>>0),n.ncmdread=3,this.enqueueEvent(3,130);break;case 6:psx.setEvent(this.eventRead,a>>>0),n.ncmdread=6,this.enqueueEvent(3,66),n.currLoc=n.seekLoc;break;case 7:this.enqueueEvent(3,0),n.ncmdctrl=112,n.status|=128;break;case 112:this.enqueueEvent(2,2);break;case 8:this.enqueueEvent(3,2),psx.setEvent(this.eventCmd,(128&n.mode?25845878:13863626)>>>0),n.ncmdctrl=128,n.status|=128;break;case 128:this.enqueueEvent(2,0);break;case 9:n.results.push(32|n.statusCode),psx.setEvent(this.eventCmd,(128&n.mode?1097107:2168860)>>>0),n.ncmdctrl=144,n.status|=128,n.status|=32,n.setIrq(3);break;case 144:n.statusCode=-33&n.statusCode|2,n.results.push(n.statusCode),n.status&=-129,n.status|=32,n.setIrq(2);break;case 153:n.statusCode=-161&n.statusCode|2,n.results.push(n.statusCode),n.status&=-129,n.status|=32,n.setIrq(4);break;case 10:this.enqueueEvent(3,2),psx.setEvent(this.eventCmd,4096),n.ncmdctrl=160,n.status|=128;break;case 160:this.enqueueEvent(2,2);break;case 11:this.enqueueEvent(3,2),this.mute=!0;break;case 12:this.enqueueEvent(3,2),this.mute=!1;break;case 13:this.filter={file:n.params[0],chan:n.params[1]},this.enqueueEvent(3,2);break;case 14:this.enqueueEvent(3,2),this.mode=n.params[0];break;case 15:this.enqueueEvent(3,2,n.mode,0,n.filter.file,n.filter.chan);break;case 16:n.results.push(n.cdImage.getInt8(n.sectorOffset+12+0)),n.results.push(n.cdImage.getInt8(n.sectorOffset+12+1)),n.results.push(n.cdImage.getInt8(n.sectorOffset+12+2)),n.results.push(n.cdImage.getInt8(n.sectorOffset+12+3)),n.results.push(n.cdImage.getInt8(n.sectorOffset+12+4)),n.results.push(n.cdImage.getInt8(n.sectorOffset+12+5)),n.results.push(n.cdImage.getInt8(n.sectorOffset+12+6)),n.results.push(n.cdImage.getInt8(n.sectorOffset+12+7)),n.status&=-129,n.status|=32,n.setIrq(3);break;case 17:{let e=n.currLoc-150-n.currTrack.begin,r=e/4500>>0,s=(e/75>>0)%60,a=e%75;n.results.push(t(n.currTrack.id)),n.results.push(1),n.results.push(t(r)),n.results.push(t(s)),n.results.push(t(a)),n.results.push(t((n.currLoc-150)/75/60%60)),n.results.push(t((n.currLoc-150)/75%60)),n.results.push(t((n.currLoc-150)%75)),n.status&=-129,n.status|=32,n.setIrq(3)}break;case 19:console.log("CdlGetTN"),n.statusCode|=2,n.results.push(n.statusCode),n.results.push(1),n.results.push(t(this.tracks.length-1)),n.status&=-129,n.status|=32,n.setIrq(3);break;case 20:{let e=0,s=this.tracks[r(n.params[0])];if(!s){n.statusCode|=16,n.results.push(17),n.results.push(128),n.status&=-129,n.status|=32,n.setIrq(5);break}e=0===n.params[0]?Math.floor((s.end+150)/75):Math.floor((s.begin+150)/75),console.log(`CdlGetTD: ${n.params[0]}`,s),n.statusCode|=2,n.results.push(n.statusCode),n.results.push(t(Math.floor(e/60))),n.results.push(t(Math.floor(e%60))),n.status&=-129,n.status|=32,n.setIrq(3)}break;case 21:psx.setEvent(this.eventCmd,4096),n.ncmdctrl=336,this.enqueueEvent(3,66),n.status|=128;break;case 336:this.enqueueEvent(2,2),n.currLoc=n.seekLoc;break;case 22:psx.setEvent(this.eventCmd,4096),n.ncmdctrl=352,this.enqueueEvent(3,66),n.status|=128;break;case 352:this.enqueueEvent(2,2),n.currLoc=n.seekLoc;break;case 25:n.results.push(153),n.results.push(2),n.results.push(1),n.results.push(195),n.status&=-129,n.status|=32,n.setIrq(3);break;case 26:psx.setEvent(this.eventCmd,18944),n.results.push(n.statusCode),n.ncmdctrl=416,n.status|=32,n.setIrq(3);break;case 416:n.hasCdFile?(n.results.push(2),n.results.push(0),n.results.push(32),n.results.push(0),n.results.push("e".charCodeAt(0)),n.results.push("N".charCodeAt(0)),n.results.push("G".charCodeAt(0)),n.results.push("E".charCodeAt(0)),n.status&=-129,n.status|=32,n.setIrq(2)):(n.statusCode|=16,n.results.push(17),n.results.push(128),n.status&=-129,n.status|=32,n.setIrq(5));break;case 27:psx.setEvent(this.eventRead,a>>>0),n.ncmdread=27,this.enqueueEvent(3,66),n.currLoc=n.seekLoc;break;case 30:psx.setEvent(this.eventCmd,4096),n.ncmdctrl=480,this.enqueueEvent(3,2);break;case 480:this.enqueueEvent(2,2);break;default:abort("unimplemented async command: $"+hex(n.ncmdctrl,2))}n.lastCommand=i,n.resetparams()},eventRead:null,completeRead:function(e,r){if(31&n.irq)return void psx.updateEvent(e,64);let s=33868800/(128&n.mode?150:75),a=n.currLoc-150;switch(n.ncmdread){case 3:if(n.playIndex=0,n.currLoc===n.currTrack.end&&(console.log("end-of-track:",n.currTrack),2&n.mode))return console.log("- autopause:"),psx.unsetEvent(e),n.command(153);if(5==(5&n.mode)){switch(a%75){case 0:case 20:case 40:case 60:{let e=a/4500>>0,r=(a/75>>0)%60,s=a%75;n.results.push(130,t(n.currTrack.id),1,t(e),t(r),t(s),0,0),n.status&=-129,n.status|=64,n.status|=32,n.setIrq(1)}break;case 10:case 30:case 50:case 70:{let e=n.currLoc-n.currTrack.begin,r=e/4500>>0,s=(e/75>>0)%60,a=e%75;n.results.push(130,t(n.currTrack.id),1,t(r),128|t(s),t(a),0,0),n.status&=-129,n.status|=64,n.status|=32,n.setIrq(1)}}n.readSector(n.currLoc),psx.updateEvent(e,s),n.currLoc++;break}case 6:case 27:n.results.push(34),n.status&=-129,n.status|=64,n.status|=32,n.setIrq(1),n.readSector(n.currLoc),psx.updateEvent(e,s),n.currLoc++;break;default:console.log("unimplemented async read: $"+hex(n.ncmdread,2)),psx.unsetEvent(this.eventRead)}},readSector:function(e){if(void 0!==n.cdImage){for(let t=1;t<n.tracks.length;++t){let r=n.currTrack=n.tracks[t];if(r.begin<e&&e<r.end)break}switch(n.sectorOffset=2352*(e-150),48&n.mode){case 0:n.sectorIndex=24,n.sectorSize=2048;break;case 16:n.sectorIndex=24,n.sectorSize=2328;break;case 32:case 48:n.sectorIndex=12,n.sectorSize=2340}if(n.sectorEnd=n.sectorIndex+n.sectorSize,0!=(72&n.mode)){if(2!==s[n.sectorOffset+15])return;if(72==(72&n.mode)){if(s[n.sectorOffset+16]!==n.filter.file)return;if(s[n.sectorOffset+17]!==n.filter.chan)return}if(68!=(68&s[n.sectorOffset+18]))return;var t=s[n.sectorOffset+19];switch(t>>>0&3){case 0:var r="mono";break;case 1:r="stereo"}switch(t>>>2&1){case 0:var a=37800;break;case 1:a=18900}switch(t>>>4&3){case 0:break;case 1:}switch(t>>>6&1){case 0:break;case 1:}if(n.pcmidx=0,n.xa.fill(0),n.pcm.fill(0),"stereo"===r)var i=n.decodeStereo();if("mono"===r)i=n.decodeMono();for(var c=44100*i/a,o=0,h=0,u=n.xa,d=(i=-1,n.pcm),l=0;l<c;l+=2)d[++i]=u[o+0],d[++i]=u[o+1],(h+=a)>=44100&&(h-=44100,o+=2);n.pcmmax=i}}},nextpcm:function(e){if(3===n.ncmdread){if(n.currTrack.audio){const t=n.sectorOffset+n.playIndex>>1;let r=a[t+0]/32768,s=a[t+1]/32768,i=r*n.volCdLeft2SpuLeft+s*n.volCdRight2SpuLeft,c=s*n.volCdRight2SpuRight+r*n.volCdLeft2SpuRight;e[0]=i,e[1]=c}return n.currTrack.data&&(e[0]=0,e[1]=0),void(n.playIndex+=4)}if(0!=(72&n.mode)){n.pcmidx>=n.pcmmax-1&&(n.pcmidx=n.pcmmax-1);let t=n.pcm[n.pcmidx+0],r=n.pcm[n.pcmidx+1],s=t*n.volCdLeft2SpuLeft+r*n.volCdRight2SpuLeft,a=r*n.volCdRight2SpuRight+t*n.volCdLeft2SpuRight;e[0]=s,e[1]=a,n.pcmidx+=2}},decodeMono:function(){for(var e=0,t=this.sl,r=n.xa,a=0;a<18;++a)for(var i=n.sectorOffset+24+128*a,c=0;c<8;++c)for(var o=s[i+4+c],h=(15&o)>>>0,u=(240&o)>>>3,d=xa2flt[u+0],l=xa2flt[u+1],f=0;f<28;++f){var p=2*(256*h+(255&s[i+16+4*f+c/2>>>0])),m=t[1]*d+t[0]*l+xa2pcm[p+(1&c)];t[0]=t[1],t[1]=m,r[e++]=m,r[e++]=m}return e},sl:[0,0],sr:[0,0],decodeStereo:function(){for(var e=0,t=this.sl,r=this.sr,a=n.xa,i=0;i<18;++i)for(var c=n.sectorOffset+24+128*i,o=0;o<8;o+=2){for(var h=(15&(g=s[c+4+o]))>>>0,u=(240&g)>>>3,d=xa2flt[u+0],l=xa2flt[u+1],f=0;f<28;++f){var p=2*(256*h+(255&s[c+16+4*f+o/2>>>0])),m=t[1]*d+t[0]*l+xa2pcm[p+0];t[0]=t[1],t[1]=m,a[e+2*f+0]=m}var g;for(h=(15&(g=s[c+5+o]))>>>0,u=(240&g)>>>3,d=xa2flt[u+0],l=xa2flt[u+1],f=0;f<28;++f){p=2*(256*h+(255&s[c+16+4*f+o/2>>>0])),m=r[1]*d+r[0]*l+xa2pcm[p+1];r[0]=r[1],r[1]=m,a[e+2*f+1]=m}e+=56}return e},stopReading:function(){psx.unsetEvent(n.eventRead),n.statusCode&=-129,n.statusCode&=-33,n.ncmdread=0},dmaTransferMode0000:function(e,t){var r=(65535&t)<<2;clearCodeCache(e,r);for(var s=0;s<r;s+=4)map[(2097151&e)>>2]=i[n.sectorOffset+n.sectorIndex>>2],n.sectorIndex+=4,e+=4;return n.sectorIndex>=n.sectorEnd&&(n.status&=-65),r},setTOC:function(e){this.tracks=e},setCdImage:function(e){i=new Int32Array(e.buffer),a=new Int16Array(e.buffer),s=new Int8Array(e.buffer),n.hasCdFile=!0,n.cdImage=e}};e.cdr=Object.seal(n)})(window),(e=>{"use strict";const t=JSON.parse(localStorage.getItem("config")||'{"quality": 1}');t.updateQuality=(e=>{const r=document.getElementById("quality");e&&(t.quality<<=1,t.quality>8&&(t.quality=1),localStorage.setItem("config",JSON.stringify(t)),r.classList.add("restart")),r.innerText=`Q${t.quality}`}),e.settings=t})(window),(e=>{"use strict";const t={clock:0,eventClock:0,events:[],inactiveEvents:[],lastId:0,addEvent:(e,r)=>{const s=Object.seal({id:t.lastId++,active:!0,clock:+t.clock+ +e,start:+t.clock,cb:r});return t.eventClock>s.clock&&(t.eventClock=s.clock),t.events.push(s),s},updateEvent:(e,r)=>(e.start=e.clock,e.clock+=+r,e.active=!0,t.eventClock>e.clock&&(t.eventClock=e.clock),e),unsetEvent:e=>{if(!e.active)return;const r=t.events.findIndex(t=>t.id===e.id);return-1!==r&&(t.inactiveEvents.push(e),t.events.splice(r,1),e.active=!1),e},eventCycles:e=>+t.clock-e.start,setEvent:(e,r)=>{if(!e.active){const r=t.inactiveEvents.findIndex(t=>t.id===e.id);-1!==r&&(t.inactiveEvents.splice(r,1),t.events.push(e))}return e.clock=+t.clock+ +r,e.start=+t.clock,e.active=!0,t.eventClock>e.clock&&(t.eventClock=e.clock),e},handleEvents:e=>{let r=Number.MAX_SAFE_INTEGER;const s=[];for(let e=0,r=t.events.length;e<r;++e){const r=t.events[e];t.clock>=r.clock&&s.push(r)}for(let e=0,r=s.length;e<r;++e){const r=s[e];r.cb(r,t.clock)}for(let e=0,s=t.events.length;e<s;++e){const s=t.events[e];s.clock<r&&s.active&&(r=s.clock)}return t.eventClock=r,cpuInterrupt(e)}};e.psx=Object.seal(t)})(window);var qwf=settings.quality||1,qhf=settings.quality||1,qwidth=1024*qwf,qheight=512*qhf;Uint32Array.prototype.addVertexDisp=function(e,t,r,s){var a=t<<16|65535&e,i=s<<16|65535&r,n=this.index>>>2;this[n+0]=a,this[n+1]=i,this.index+=8},Uint32Array.prototype.addVertex=function(e,t,r){var s=(t*=16)<<16|65535&(e*=16),a=this.index>>>2;this[a+0]=16777215&r|50331648,this[a+1]=s,this.index+=24},Uint32Array.prototype.addVertexUV=function(e,t,r,s,a,i,n,c){var o=(t*=16)<<16|65535&(e*=16),h=i<<16|65535&a,u=c<<16|65535&n,d=gpu.ty<<16|65535&gpu.tx,l=this.index>>>2;this[l+0]=16777215&r|s<<24,this[l+1]=o,this[l+2]=h,this[l+3]=u,this[l+4]=d,this[l+5]=gpu.twin,this.index+=24},Uint32Array.prototype.getNumberOfVertices=function(){return this.index/24},Uint32Array.prototype.canHold=function(e){return this.index+24*e<4*this.length},Uint32Array.prototype.reset=function(){this.index=0},Uint32Array.prototype.view=function(){return new Uint32Array(this.buffer,0,this.index>>2)};const vertexShaderDisplay="precision highp float;attribute vec2 aVertexPosition;attribute vec2 aVertexTexture;varying vec2 vTextureCoord;varying vec2 tx;void main(void) {  gl_Position = vec4(aVertexPosition, 0.0, 1.0);  tx.xy = aVertexTexture;  vTextureCoord.x = aVertexTexture.x / 1024.0;  vTextureCoord.y = aVertexTexture.y / 512.0;}",fragmentShader16bit="precision highp float;uniform sampler2D uVRAM;varying vec2 tx;vec4 getColor(float tx, float ty) {  if (ty >= 511.0) ty = 511.0;  if (tx >= 1023.0) tx = 1023.0;  return texture2D(uVRAM, vec2((tx + 0.0) / 1024.0, (ty + 0.0) / 512.0));}void main(void) {  gl_FragColor = vec4(getColor(tx.x, tx.y).rgb, 1.0);}",fragmentShaderTexture="precision highp float;uniform sampler2D uVRAM;varying vec2 vTextureCoord;void main(void) {  vec4 pixel = texture2D(uVRAM, vTextureCoord);  gl_FragColor = vec4(pixel.aaa, 1.0);}",fragmentShader24bit="precision highp float;uniform sampler2D uVRAM;uniform vec3 ts;varying vec2 tx;varying vec2 vTextureCoord;vec4 getColor(float tx, float ty) {  if (ty >= 512.0) ty = 512.0;  if (tx >= 2048.0) tx = 2048.0;  float r = texture2D(uVRAM, vec2((tx + 0.0) / 2048.0, ty / 512.0)).a;  float g = texture2D(uVRAM, vec2((tx + 1.0) / 2048.0, ty / 512.0)).a;  float b = texture2D(uVRAM, vec2((tx + 2.0) / 2048.0, ty / 512.0)).a;  return vec4(r, g, b, 0.0);}void main(void) {  float td = (tx.x - ts.x);  float x = 3.0 * floor(td) + 2.0 * ts.x;  gl_FragColor = getColor(x , floor(tx.y));}",vertexShaderDraw="precision highp float;attribute vec2 aVertexPosition;attribute vec2 aVertexTexture;attribute vec4 aVertexColor;attribute vec4 aTextureWindow;attribute vec2 aTexturePage;attribute vec2 aTextureClut;uniform float uBlendAlpha;varying float vTextureMode;varying float vSTP;varying vec4 vColor;varying vec2 vClut;varying float tmx;varying float tmy;varying float tox;varying float toy;varying float tcx;varying float tcy;varying float twin;void main(void) {  gl_Position = vec4(aVertexPosition, 0.0, 1.0);   gl_Position.x -= 8192.0; gl_Position.y -= 4096.0;  gl_Position.x /= 8192.0; gl_Position.y /= 4096.0;  vClut = aTextureClut;  vClut.x /= 1024.0;  vClut.y /= 512.0;  twin = aTextureWindow.x + aTextureWindow.y;  tmx = 256.0 - aTextureWindow.x;  tmy = 256.0 - aTextureWindow.y;  tox = aTexturePage.x + aTextureWindow.z;  toy = aTexturePage.y + aTextureWindow.a;  tcx = aVertexTexture.x;  tcy = aVertexTexture.y;  vTextureMode = mod(aVertexColor.a, 8.0);  if (vTextureMode == 7.0) {    tcx = aVertexPosition.x / 8192.0 / 2.0;    tcy = aVertexPosition.y / 4096.0 / 2.0;  }  else {    vSTP = floor(aVertexColor.a / 8.0);  }  vColor = vec4(aVertexColor.rgb / 256.0, uBlendAlpha);}",fragmentShaderDraw="precision highp float;uniform sampler2D uTex8;uniform float uBlendAlpha;varying float vTextureMode;varying float vSTP;varying vec4 vColor;varying vec2 vClut;varying float tmx;varying float tmy;varying float tox;varying float toy;varying float tcx;varying float tcy;varying float twin;float getSRGB16(float cx, float cy) {  float tx = floor(cx * 1024.0) * 2.0;  float ty = floor(cy * 512.0);  float lo = floor(texture2D(uTex8, vec2(tx + 0.0, ty) / vec2(2048.0, 512.0)).a * 255.0);  float hi = floor(texture2D(uTex8, vec2(tx + 1.0, ty) / vec2(2048.0, 512.0)).a * 255.0);  return hi * 256.0 + lo;}vec4 getColor(float cx, float cy) {  float srgb = getSRGB16(cx, cy);  float r = mod(floor(srgb /     1.0), 32.0) / 32.0;  float g = mod(floor(srgb /    32.0), 32.0) / 32.0;  float b = mod(floor(srgb /  1024.0), 32.0) / 32.0;  float a = srgb >= 32768.0 ? 1.0 : 0.0;  return vec4(r, g, b, a);}vec4 getClutColor(float ox) {  float cx, cy, val, tx, ty;  if (twin != 0.0) {    tx = tox + mod(floor(tcx + ox), tmx);    ty = toy + mod(floor(tcy), tmy);  }  else {    tx = tox + floor(tcx + ox);    ty = toy + floor(tcy);  }  if (vTextureMode == 1.0) {    val = texture2D(uTex8, vec2(tx / 2048.0, ty / 512.0)).a * 255.0;    cx = vClut.x + (val / 1024.0); cy = vClut.y;  }  else  if (vTextureMode == 0.0) {    val = texture2D(uTex8, vec2(tx / 4096.0, ty / 512.0)).a * 255.0;    if (mod((tx), 2.0) == 0.0) { val = mod(val, 16.0); } else { val = mod(floor(val / 16.0), 16.0); }    cx = vClut.x + (val / 1024.0); cy = vClut.y;  }  else  if (vTextureMode == 2.0) {    vec4 rgba = texture2D(uTex8, vec2(tx / 1024.0, ty / 512.0));    return vec4(rgba.rgb, 0.0);  }  vec4 rgba = getColor(cx, cy);  if (rgba.a == 0.0) {    if (vSTP == 3.0) return vec4(0.0,0.0,0.0,0.0);  }  else {    if (vSTP == 2.0) return vec4(0.0,0.0,0.0,0.0);  }  return rgba;}void main(void) {  float fx = tcx - floor(tcx);  float fy = tcy - floor(tcy);  if (vTextureMode == 7.0) {    gl_FragColor = getColor(tcx, tcy);    return;  }  if (vTextureMode == 3.0) {    gl_FragColor = vec4(vColor.rgb, uBlendAlpha);    return;  }  vec4 c = getClutColor(0.0);  if (c == vec4(0.0, 0.0, 0.0, 0.0)) discard;  gl_FragColor = vec4(2.0 * (vColor.rgb * c.rgb), uBlendAlpha);}";function WebGLRenderer(e){this.gl=null,this.programDisplay=null,this.vertexBuffer=new Uint32Array(4608),this.drawOffsetX=0,this.drawOffsetY=0,this.displaymode=2,this.vram=new Uint16Array(524288),this.vertexClip=!1,this.drawAreaChange=!1;try{this.gl=e.getContext("webgl",{alpha:!1,antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!1,depth:!1,stencil:!1,powerPreference:"high-performance"})}catch(e){return void alert("Error: Unable to get WebGL context")}if(this.gl){this.initShaders(),this.initTextures(),this.setupBuffers();var t=this.gl;this.setupWebGL(e),t.useProgram(this.programDraw),t.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf16draw),t.activeTexture(this.gl.TEXTURE1),t.bindTexture(this.gl.TEXTURE_2D,this.tex8vram),this.vertexBuffer.reset(),this.setupProgramDraw()}else alert("Error: Your browser does not appear to support WebGL.")}WebGLRenderer.prototype.getClutInfo=function(e,t){if(2===t)return 3;if(1===t)var r=256;if(0===t)r=16;for(var s=0,a=1024*(e>>>6&511)+16*(e>>>0&63),i=this.vram;--r>=0;){var n=i[a++];0!==n&&(s|=n<=32767?1:2)}return s},WebGLRenderer.prototype.outsideDrawArea=function(e,t,r,s,a,i){return e<this.drawAreaL&&r<this.drawAreaL&&a<this.drawAreaL||(e>this.drawAreaR&&r>this.drawAreaR&&a>this.drawAreaR||(t<this.drawAreaT&&s<this.drawAreaT&&i<this.drawAreaT||t>this.drawAreaB&&s>this.drawAreaB&&i>this.drawAreaB))},WebGLRenderer.prototype.largePrimitive=function(e,t,r,s,a,i){return Math.abs(e-r)>1023||(Math.abs(r-a)>1023||(Math.abs(a-e)>1023||(Math.abs(t-s)>511||(Math.abs(s-i)>511||Math.abs(i-t)>511))))},WebGLRenderer.prototype.setupWebGL=function(e){var t=this.gl;t.viewport(0,0,e.width,e.height),t.disable(t.STENCIL_TEST),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DITHER),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SAMPLE_COVERAGE),t.disable(t.SCISSOR_TEST),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.clear(t.DEPTH_BUFFER_BIT),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.PACK_ALIGNMENT,1),this.canvas=e},WebGLRenderer.prototype.initShaders=function(){try{var e=this.gl;this.programDraw=e.createProgram(),e.attachShader(this.programDraw,this.makeShader(vertexShaderDraw,e.VERTEX_SHADER)),e.attachShader(this.programDraw,this.makeShader(fragmentShaderDraw,e.FRAGMENT_SHADER)),e.linkProgram(this.programDraw),e.getProgramParameter(this.programDraw,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.programDraw),this.programDraw.uTex8=e.getUniformLocation(this.programDraw,"uTex8"),e.uniform1i(this.programDraw.uTex8,1),this.programDisplay=e.createProgram(),e.attachShader(this.programDisplay,this.makeShader(vertexShaderDisplay,e.VERTEX_SHADER)),e.attachShader(this.programDisplay,this.makeShader(fragmentShader16bit,e.FRAGMENT_SHADER)),e.linkProgram(this.programDisplay),e.getProgramParameter(this.programDisplay,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.programDisplay),this.programDisplay.vram=e.getUniformLocation(this.programDisplay,"uVRAM"),this.programDisplay.ts=e.getUniformLocation(this.programDisplay,"ts"),e.uniform1i(this.programDisplay.vram,0),this.program24bit=e.createProgram(),e.attachShader(this.program24bit,this.makeShader(vertexShaderDisplay,e.VERTEX_SHADER)),e.attachShader(this.program24bit,this.makeShader(fragmentShader24bit,e.FRAGMENT_SHADER)),e.linkProgram(this.program24bit),e.getProgramParameter(this.program24bit,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.program24bit),this.program24bit.vram=e.getUniformLocation(this.program24bit,"uVRAM"),this.program24bit.ts=e.getUniformLocation(this.program24bit,"ts"),e.uniform1i(this.program24bit.vram,1),this.programTexture=e.createProgram(),e.attachShader(this.programTexture,this.makeShader(vertexShaderDisplay,e.VERTEX_SHADER)),e.attachShader(this.programTexture,this.makeShader(fragmentShaderTexture,e.FRAGMENT_SHADER)),e.linkProgram(this.programTexture),e.getProgramParameter(this.programTexture,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.programTexture),this.programTexture.vram=e.getUniformLocation(this.programTexture,"uVRAM"),e.uniform1i(this.programTexture.vram,0)}catch(e){console.log("Failed to init shaders:\n\n"+e.stack)}},WebGLRenderer.prototype.initTextures=function(){var e=this.gl;this.tex8vram=this.createTexture(),e.texImage2D(e.TEXTURE_2D,0,e.ALPHA,2048,512,0,e.ALPHA,e.UNSIGNED_BYTE,null),this.buf8vram=this.createBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.buf8vram),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.tex8vram,0),e.bindFramebuffer(e.FRAMEBUFFER,null),this.tex16draw=this.createTexture(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,qwidth,qheight,0,e.RGBA,e.UNSIGNED_BYTE,null),this.buf16draw=this.createBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.buf16draw),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.tex16draw,0),e.bindFramebuffer(e.FRAMEBUFFER,null),this.vramP2=this.createTexture(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,qwidth,qheight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,null)},WebGLRenderer.prototype.loadImage=function(e,t,r,s,a){let i=0;for(let n=0;n<s;++n){const s=(t+n)%512*1024;for(let t=0;t<r;++t)a[i++]=this.vram[s+(e+t)%1024]}},WebGLRenderer.prototype.moveImage=function(e,t,r,s,a,i){this.gl;var n=0,c=gpu.img;c.x=r,c.y=s,c.w=a,c.h=i,c.pixelCount=a*i;for(var o=c.buffer,h=this.vram,u=i;u>0;--u)for(var d=e,l=t++%512*1024,f=a;f>0;--f)o[n++]=h[l+d++%1024];this.storeImage(c)},WebGLRenderer.prototype.storeImage=function(e){this.gl;for(var t=0,r=e.buffer,s=this.vram,a=0;a<e.h;++a){const c=(e.y+a)%512*1024;for(var i=e.x,n=e.w;n>0;--n)s[c+i++%1024]=r[t++]}this.storeImageInTexture(e)},WebGLRenderer.prototype.storeImageInTexture=function(e){const t=this.gl;if(this.flushVertexBuffer(!0),e.x+e.w>1024){let t=1024-e.x,r=e.w-t,s=new Uint16Array(t*e.h),a=new Uint16Array(r*e.h),i=0,n=0;for(let c=0;c<e.h;++c){const o=c*e.w;for(let r=0;r<t;++r)s[i++]=e.buffer[o+r];for(let s=0;s<r;++s)a[n++]=e.buffer[o+s+t]}return this.storeImageInTexture({x:e.x,y:e.y,w:t,h:e.h,buffer:s,pixelCount:i}),void this.storeImageInTexture({x:0,y:e.y,w:r,h:e.h,buffer:a,pixelCount:n})}if(e.y+e.h>512){let t=512-e.y,r=e.h-t;return this.storeImageInTexture({x:e.x,y:e.y,w:e.w,h:t,buffer:new Uint16Array(e.buffer.buffer,0,t*e.w),pixelCount:t*e.w}),void this.storeImageInTexture({x:e.x,y:0,w:e.w,h:r,buffer:new Uint16Array(e.buffer.buffer,t*e.w),pixelCount:r*e.w})}const r=new Uint8Array(e.buffer.buffer,0,e.pixelCount<<1);t.bindTexture(t.TEXTURE_2D,this.tex8vram),t.texSubImage2D(t.TEXTURE_2D,0,e.x<<1,e.y,e.w<<1,e.h,t.ALPHA,t.UNSIGNED_BYTE,r);var s=e.x,a=e.x+e.w,i=e.y,n=e.y+e.h,c=this.getVertexBuffer(6,0);c.addVertexUV(s,i,0,7,0,0,0,0),c.addVertexUV(a,i,0,7,0,0,0,0),c.addVertexUV(s,n,0,7,0,0,0,0),c.addVertexUV(a,i,0,7,0,0,0,0),c.addVertexUV(s,n,0,7,0,0,0,0),c.addVertexUV(a,n,0,7,0,0,0,0),this.flushVertexBuffer(!1)},WebGLRenderer.prototype.makeShader=function(e,t){var r=this.gl;if(e===vertexShaderDisplay||e===fragmentShader16bit||e===fragmentShaderTexture||e===fragmentShader24bit||e===vertexShaderDraw||e===fragmentShaderDraw){var s=r.createShader(t);return r.shaderSource(s,e),r.compileShader(s),r.getShaderParameter(s,r.COMPILE_STATUS)||(alert("Error compiling shader: "+r.getShaderInfoLog(s)),r.deleteShader(s)),s}},WebGLRenderer.prototype.setupBuffers=function(){var e=this.gl;this.programDraw.blendAlpha=e.getUniformLocation(this.programDraw,"uBlendAlpha"),this.programDraw.vertexPosition=e.getAttribLocation(this.programDraw,"aVertexPosition"),e.enableVertexAttribArray(this.programDraw.vertexPosition),this.programDraw.vertexTexture=e.getAttribLocation(this.programDraw,"aVertexTexture"),e.enableVertexAttribArray(this.programDraw.vertexTexture),this.programDraw.textureWindow=e.getAttribLocation(this.programDraw,"aTextureWindow"),e.enableVertexAttribArray(this.programDraw.textureWindow),this.programDraw.texturePage=e.getAttribLocation(this.programDraw,"aTexturePage"),e.enableVertexAttribArray(this.programDraw.texturePage),this.programDraw.vertexColor=e.getAttribLocation(this.programDraw,"aVertexColor"),e.enableVertexAttribArray(this.programDraw.vertexColor),this.programDraw.aclut=e.getAttribLocation(this.programDraw,"aTextureClut"),e.enableVertexAttribArray(this.programDraw.aclut),this.programDraw.vertexTexture=e.getAttribLocation(this.programDraw,"aVertexTexture"),e.enableVertexAttribArray(this.programDraw.vertexTexture),this.programDisplay.vertexPosition=e.getAttribLocation(this.programDraw,"aVertexPosition"),e.enableVertexAttribArray(this.programDisplay.vertexPosition),this.programDisplay.vertexTexture=e.getAttribLocation(this.programDisplay,"aVertexTexture"),e.enableVertexAttribArray(this.programDisplay.vertexTexture),this.program24bit.vertexTexture=e.getAttribLocation(this.program24bit,"aVertexTexture"),e.enableVertexAttribArray(this.program24bit.vertexTexture),this.program24bit.vertexPosition=e.getAttribLocation(this.program24bit,"aVertexPosition"),e.enableVertexAttribArray(this.program24bit.vertexPosition),this.programTexture.vertexPosition=e.getAttribLocation(this.programDraw,"aVertexPosition"),e.enableVertexAttribArray(this.programTexture.vertexPosition),this.programTexture.vertexTexture=e.getAttribLocation(this.programDisplay,"aVertexTexture"),e.enableVertexAttribArray(this.programTexture.vertexTexture),this.canvasBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.canvasBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertexBuffer,e.DYNAMIC_DRAW)},WebGLRenderer.prototype.createBuffer=function(){var e=this.gl,t=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,t),t},WebGLRenderer.prototype.createTexture=function(e){var t=this.gl,r=t.createTexture();return void 0===e&&(e=t.NEAREST),t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),r},WebGLRenderer.prototype.setupProgramDraw=function(){var e=this.gl;e.viewport(0,0,qwidth,qheight),e.useProgram(this.programDraw),e.bindFramebuffer(e.FRAMEBUFFER,this.buf16draw),e.vertexAttribPointer(this.programDraw.vertexColor,4,e.UNSIGNED_BYTE,!1,24,0),e.vertexAttribPointer(this.programDraw.vertexPosition,2,e.SHORT,!1,24,4),e.vertexAttribPointer(this.programDraw.vertexTexture,2,e.SHORT,!1,24,8),e.vertexAttribPointer(this.programDraw.aclut,2,e.SHORT,!1,24,12),e.vertexAttribPointer(this.programDraw.texturePage,2,e.SHORT,!1,24,16),e.vertexAttribPointer(this.programDraw.textureWindow,4,e.UNSIGNED_BYTE,!1,24,20),e.enable(e.SCISSOR_TEST)},WebGLRenderer.prototype.flushVertexBuffer=function(e){const t=this.gl;if(this.vertexBuffer.index<=0)return;if(this.vertexClip!==e||!e||this.drawAreaChange){if(t.enable(t.SCISSOR_TEST),e){let e=(this.drawAreaB-this.drawAreaT+1)*qhf,r=this.drawAreaT*qhf;t.scissor(this.drawAreaL*qwf,r,(this.drawAreaR-this.drawAreaL+1)*qwf,e)}else t.scissor(0,0,1024*qwf,512*qhf);this.vertexClip=e}const r=this.vertexBuffer.view(),s=this.vertexBuffer.getNumberOfVertices();switch(t.bufferData(t.ARRAY_BUFFER,r,t.STREAM_DRAW),this.renderMode>>4){case 0:case 1:t.activeTexture(this.gl.TEXTURE1),t.bindTexture(this.gl.TEXTURE_2D,this.tex8vram),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.vramP2,0),t.drawArrays(t.TRIANGLES,0,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.tex16draw,0),t.drawArrays(t.TRIANGLES,0,s);break;case 2:case 3:t.activeTexture(this.gl.TEXTURE1),t.bindTexture(this.gl.TEXTURE_2D,this.tex16draw),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.vramP2,0),t.drawArrays(t.TRIANGLES,0,s),t.bindTexture(this.gl.TEXTURE_2D,this.vramP2),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.tex16draw,0),t.drawArrays(t.TRIANGLES,0,s),t.bindTexture(this.gl.TEXTURE_2D,this.tex8vram)}this.vertexBuffer.reset()},WebGLRenderer.prototype.setBlendMode=function(e){if(this.renderMode!==e){this.flushVertexBuffer(!0),this.renderMode=e;var t=this.gl;switch(15&e){case 0:t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.SRC_ALPHA),t.uniform1f(this.programDraw.blendAlpha,.5);break;case 1:t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE),t.uniform1f(this.programDraw.blendAlpha,1);break;case 2:t.enable(t.BLEND),t.blendEquation(t.FUNC_REVERSE_SUBTRACT),t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_COLOR),t.uniform1f(this.programDraw.blendAlpha,1);break;case 3:t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE_MINUS_SRC_ALPHA,t.ONE),t.uniform1f(this.programDraw.blendAlpha,.75);break;case 4:t.disable(t.BLEND)}}},WebGLRenderer.prototype.getVertexBuffer=function(e,t){var r=(33554432&(t||0)?gpu.status>>5&3:4)|gpu.tp<<4;return this.vertexBuffer.canHold(e)||this.flushVertexBuffer(!0),this.setBlendMode(r),this.vertexBuffer},WebGLRenderer.prototype.switchDisplayMode=function(){this.displaymode=(this.displaymode+1)%3},WebGLRenderer.prototype.drawLine=function(e,t,r,s,a){var i=this.drawOffsetX+(e[r]<<21>>21),n=this.drawOffsetY+(e[r]<<5>>21),c=this.drawOffsetX+(e[a]<<21>>21),o=this.drawOffsetY+(e[a]<<5>>21);if(!this.outsideDrawArea(i,n,c,o,i,n)&&!this.largePrimitive(i,n,c,o,i,n)){var h=Math.abs(i-c),u=Math.abs(n-o),d=this.getVertexBuffer(6,e[0]);i!==c||n!==o?h>=u?(d.addVertex(i,n+1,e[t]),d.addVertex(i,n+0,e[t]),d.addVertex(c,o+0,e[s]),d.addVertex(c,o+0,e[s]),d.addVertex(c,o+1,e[s]),d.addVertex(i,n+1,e[t])):(d.addVertex(i+0,n,e[t]),d.addVertex(i+1,n,e[t]),d.addVertex(c+1,o,e[s]),d.addVertex(c+1,o,e[s]),d.addVertex(c+0,o,e[s]),d.addVertex(i+0,n,e[t])):(d.addVertex(c+0,o+0,e[s]),d.addVertex(c+1,o+0,e[s]),d.addVertex(c+0,o+1,e[s]),d.addVertex(c+0,o+1,e[s]),d.addVertex(c+1,o+0,e[s]),d.addVertex(c+1,o+1,e[s]))}},WebGLRenderer.prototype.drawTriangle=function(e,t,r,s,a,i,n,c,o,h,u,d,l){switch(e[0]>>24&15){case 5:case 7:case 13:case 15:e[t]=4278190080&e[t]|8421504,e[s]=4278190080&e[s]|8421504,e[i]=4278190080&e[i]|8421504}var f=this.drawOffsetX+(e[r]<<21>>21),p=this.drawOffsetY+(e[r]<<5>>21),m=this.drawOffsetX+(e[a]<<21>>21),g=this.drawOffsetY+(e[a]<<5>>21),x=this.drawOffsetX+(e[n]<<21>>21),b=this.drawOffsetY+(e[n]<<5>>21);if(!this.outsideDrawArea(f,p,m,g,x,b)&&!this.largePrimitive(f,p,m,g,x,b)){if(!(67108864==(67108864&e[0])))return(k=this.getVertexBuffer(3,e[0])).addVertex(f,p,16711422&e[t]),k.addVertex(m,g,16711422&e[s]),void k.addVertex(x,b,16711422&e[i]);(gpu.txflip||gpu.tyflip)&&console.warn("texture flip with triangles");var k,v=e[h]>>>0&255,R=e[h]>>>8&255,w=e[u]>>>0&255,C=e[u]>>>8&255,T=e[d]>>>0&255,y=e[d]>>>8&255,A=16*(l>>>0&63),S=l>>>6&511,E=Math.min(gpu.status>>7&3,2),P=33554432==(33554432&e[0]),L=3;if(P&&(L=this.getClutInfo(l,E)),!P||2==(2&L))(k=this.getVertexBuffer(3,e[0])).addVertexUV(f,p,16711422&e[t],8|E,v,R,A,S),k.addVertexUV(m,g,16711422&e[s],8|E,w,C,A,S),k.addVertexUV(x,b,16711422&e[i],8|E,T,y,A,S);if(P&&1==(1&L))(k=this.getVertexBuffer(3,0)).addVertexUV(f,p,16711422&e[t],16|E,v,R,A,S),k.addVertexUV(m,g,16711422&e[s],16|E,w,C,A,S),k.addVertexUV(x,b,16711422&e[i],16|E,T,y,A,S)}},WebGLRenderer.prototype.drawRectangle=function(e,t,r,s){switch(e[0]>>24&15){case 5:case 7:case 13:case 15:e[0]=4278190080&e[0]|8421504}var a=this.drawOffsetX+(e[1]<<21>>21),i=this.drawOffsetY+(e[1]<<5>>21),n=16711422&e[0],c=e[2]<<16>>16,o=e[2]>>16;if(c&&o){var h=!this.outsideDrawArea(a+0,i+0,a+c-1,i+0,a+0,i+o-1),u=!this.outsideDrawArea(a+0,i+o-1,a+c-1,i+0,a+c-1,i+o-1);if(h||u){if(!(67108864==(67108864&e[0])))return(b=this.getVertexBuffer(6,e[0])).addVertex(a+0,i+0,n),b.addVertex(a+c,i+0,n),b.addVertex(a+0,i+o,n),b.addVertex(a+c,i+0,n),b.addVertex(a+0,i+o,n),b.addVertex(a+c,i+o,n),void(n||(this.flushVertexBuffer(!0),this.clearVRAM(a,i,c,o,n,!0)));var d=16*(s>>>0&63),l=s>>>6&511,f=Math.min(gpu.status>>7&3,2),p=t+0,m=t+c;gpu.txflip&&(p=t+0,m=t-c+1);var g=r+0,x=r+o;gpu.tyflip&&(g=r+0,x=r-o+1);var b,k=33554432==(33554432&e[0]),v=3;if(k&&(v=this.getClutInfo(s,f)),!k||2==(2&v))(b=this.getVertexBuffer(6,e[0])).addVertexUV(a+0,i+0,n,8|f,p,g,d,l),b.addVertexUV(a+c,i+0,n,8|f,m,g,d,l),b.addVertexUV(a+0,i+o,n,8|f,p,x,d,l),b.addVertexUV(a+c,i+0,n,8|f,m,g,d,l),b.addVertexUV(a+0,i+o,n,8|f,p,x,d,l),b.addVertexUV(a+c,i+o,n,8|f,m,x,d,l);if(k&&1==(1&v))(b=this.getVertexBuffer(6,0)).addVertexUV(a+0,i+0,n,16|f,p,g,d,l),b.addVertexUV(a+c,i+0,n,16|f,m,g,d,l),b.addVertexUV(a+0,i+o,n,16|f,p,x,d,l),b.addVertexUV(a+c,i+0,n,16|f,m,g,d,l),b.addVertexUV(a+0,i+o,n,16|f,p,x,d,l),b.addVertexUV(a+c,i+o,n,16|f,m,x,d,l)}}};let clr=new Uint16Array(524288);const clrState={color:0,c:0,size:524288};function display8bit(e,t){var r=e.gl;r.useProgram(e.programTexture),r.vertexAttribPointer(e.programTexture.vertexPosition,2,r.SHORT,!0,8,0),r.vertexAttribPointer(e.programTexture.vertexTexture,2,r.SHORT,!1,8,4),r.bindTexture(r.TEXTURE_2D,e.tex8vram),r.bufferSubData(r.ARRAY_BUFFER,0,t),r.drawArrays(r.TRIANGLES,0,6)}function display16bit(e,t,r,s){var a=e.gl,i=gpu.status>>22&1?2:1;a.useProgram(e.programDisplay),a.uniform3f(e.programDisplay.ts,r,s,i),a.vertexAttribPointer(e.programDisplay.vertexPosition,2,a.SHORT,!0,8,0),a.vertexAttribPointer(e.programDisplay.vertexTexture,2,a.SHORT,!1,8,4);const n=3===e.displaymode?e.vramP2:e.tex16draw;a.bindTexture(a.TEXTURE_2D,n),a.bufferSubData(a.ARRAY_BUFFER,0,t),a.drawArrays(a.TRIANGLES,0,6)}function display24bit(e,t,r,s){var a=e.gl,i=gpu.status>>22&1?2:1;a.useProgram(e.program24bit),a.uniform3f(e.program24bit.ts,r,s,i),a.vertexAttribPointer(e.program24bit.vertexPosition,2,a.SHORT,!0,8,0),a.vertexAttribPointer(e.program24bit.vertexTexture,2,a.SHORT,!1,8,4),a.bindTexture(a.TEXTURE_2D,e.tex16draw),a.bufferSubData(a.ARRAY_BUFFER,0,t),a.drawArrays(a.TRIANGLES,0,6)}clr.fill(0),WebGLRenderer.prototype.clearVRAM=function(e,t,r,s,a,i){var n=this.gl;if(i&&!(gpu.status&1<<21)){let a,i,n,c;a=e<=gpu.drawAreaX1?gpu.drawAreaX1:e,i=e>=gpu.drawAreaX2?gpu.drawAreaX2:e,n=t<=gpu.drawAreaY1?gpu.drawAreaY1:t,c=t>=gpu.drawAreaY2?gpu.drawAreaY2:t,e=a,r=i-a,t=n,s=c-n}const c=r*s>>>0;if(clrState.color!==a||clrState.size<c){clrState.color=a,clrState.size=c;const e=(a>>>19&31)<<10|(a>>>11&31)<<5|a>>>3&31;clrState.c=e,clr.fill(e,0,c)}for(let a=0;a<s;++a){const s=(t+a)%512*1024;for(let t=0;t<r;++t)this.vram[s+(e+t)%1024]=clrState.c}n.bindTexture(n.TEXTURE_2D,this.tex8vram);const o=new Uint8Array(clr.buffer,0,c<<1);n.texSubImage2D(n.TEXTURE_2D,0,e<<1,t,r<<1,s,n.ALPHA,n.UNSIGNED_BYTE,o),n.bindTexture(n.TEXTURE_2D,null)},WebGLRenderer.prototype.fillRectangle=function(e){this.gl;var t=e[1]<<16>>16,r=e[1]>>16,s=16316664&e[0],a=e[2]<<16>>>16,i=e[2]>>16>>>0;if(t&=1008,r&=511,i&=511,(a=15+(1023&a)&-16)&&i)if(t+a>1024)console.log("fillRectangle does not support x-wrap",t,a);else if(r+i>512)console.log("fillRectangle does not support y-wrap",i,r);else{this.flushVertexBuffer(!0),this.clearVRAM(t,r,a,i,s,!1);var n=this.getVertexBuffer(6,0);n.addVertex(t+0,r+0,s),n.addVertex(t+a,r+0,s),n.addVertex(t+0,r+i,s),n.addVertex(t+0,r+i,s),n.addVertex(t+a,r+0,s),n.addVertex(t+a,r+i,s),this.flushVertexBuffer(!1)}},WebGLRenderer.prototype.setDrawAreaOF=function(e,t){this.drawOffsetX=e,this.drawOffsetY=t},WebGLRenderer.prototype.setDrawAreaTL=function(e,t){this.flushVertexBuffer(!0),this.drawAreaChange=!0,this.drawAreaT=t,this.drawAreaL=e},WebGLRenderer.prototype.setDrawAreaBR=function(e,t){this.flushVertexBuffer(!0),this.drawAreaChange=!0,this.drawAreaB=t,this.drawAreaR=e},WebGLRenderer.prototype.onVBlankBegin=function(){},WebGLRenderer.prototype.onVBlankEnd=function(){var e=this.gl;this.flushVertexBuffer(!0),e.disable(e.SCISSOR_TEST),e.useProgram(this.programDisplay),this.vertexBuffer.addVertexDisp(-32768,32767,0,0),this.vertexBuffer.addVertexDisp(32767,32767,1024,0),this.vertexBuffer.addVertexDisp(-32768,-32768,0,512),this.vertexBuffer.addVertexDisp(32767,32767,1024,0),this.vertexBuffer.addVertexDisp(-32768,-32768,0,512),this.vertexBuffer.addVertexDisp(32767,-32768,1024,512),e.disable(e.BLEND),this.renderMode=5,e.bindFramebuffer(e.FRAMEBUFFER,null),e.activeTexture(e.TEXTURE0),e.vertexAttribPointer(this.programDisplay.vertexPosition,2,e.SHORT,!0,8,4),e.vertexAttribPointer(this.programDisplay.vertexTexture,2,e.SHORT,!1,8,8);var t=this.vertexBuffer.subarray(0,this.vertexBuffer.index/4);if(0===this.displaymode&&(e.viewport(0,0,this.canvas.width=2048,this.canvas.height=1024),display8bit(this,t)),1===this.displaymode&&(e.viewport(0,0,this.canvas.width=1024*qwf,this.canvas.height=512*qhf),display16bit(this,t)),3===this.displaymode&&(e.viewport(0,0,this.canvas.width=1024*qwf,this.canvas.height=512*qhf),display16bit(this,t)),2===this.displaymode){var r=gpu.getDisplayArea();this.vertexBuffer.reset();var s=r.x,a=r.x+r.w,i=r.y,n=r.y+r.h;this.vertexBuffer.addVertexDisp(-32768,32767,s,i),this.vertexBuffer.addVertexDisp(32767,32767,a,i),this.vertexBuffer.addVertexDisp(-32768,-32768,s,n),this.vertexBuffer.addVertexDisp(32767,32767,a,i),this.vertexBuffer.addVertexDisp(-32768,-32768,s,n),this.vertexBuffer.addVertexDisp(32767,-32768,a,n);t=this.vertexBuffer.subarray(0,this.vertexBuffer.index/4);gpu.status&1<<23?(e.viewport(0,0,this.canvas.width=r.w*qwf,this.canvas.height=r.h*qhf),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT)):gpu.status&1<<21?(e.viewport(0,0,this.canvas.width=r.w,this.canvas.height=r.h),display24bit(this,t,s,i)):(e.viewport(0,0,this.canvas.width=r.w*qwf,this.canvas.height=r.h*qhf),display16bit(this,t,s,i))}this.vertexBuffer.reset(),this.setupProgramDraw()},WebGLRenderer.prototype.setMode=function(e){switch(e){default:case"disp":this.displaymode=2;break;case"draw":this.displaymode=1;break;case"clut4":case"clut8":this.displaymode=0;break;case"page2":this.displaymode=3}},(e=>{"use strict";const t={dpcr:0,dicr:0,r1080:0,r1084:0,r1088:0,r1080n:0,r1090:0,r1094:0,r1098:0,r1090n:0,r10a0:0,r10a4:0,r10a8:0,r10a0n:0,r10b0:0,r10b4:0,r10b8:0,r10b0n:0,r10c0:0,r10c4:0,r10c8:0,r10c0n:0,r10e0:0,r10e4:0,r10e8:0,r10e0n:0,eventDMA0:null,completeDMA0:function(e,r){this.r1088&=4278190079,this.r1080=this.r1080n,65536&t.dicr&&(t.dicr|=2164260864,cpu.istat|=8),psx.unsetEvent(e)},eventDMA1:null,completeDMA1:function(e,r){this.r1098&=4278190079,this.r1090=this.r1090n,131072&t.dicr&&(t.dicr|=2181038080,cpu.istat|=8),psx.unsetEvent(e)},eventDMA2:null,completeDMA2:function(e,r){this.r10a8&=4278190079,this.r10a0=this.r10a0n,262144&t.dicr&&(t.dicr|=2214592512,cpu.istat|=8),psx.unsetEvent(e)},eventDMA3:null,completeDMA3:function(e,r){this.r10b8&=4278190079,this.r10b0=this.r10b0n,524288&t.dicr&&(t.dicr|=2281701376,cpu.istat|=8),psx.unsetEvent(e)},eventDMA4:null,completeDMA4:function(e,r){this.r10c8&=4278190079,this.r10c0=this.r10c0n,1048576&t.dicr&&(t.dicr|=2415919104,cpu.istat|=8),psx.unsetEvent(e)},eventDMA6:null,completeDMA6:function(e,r){this.r10e8&=4278190079,this.r10e0=this.r10e0n,4194304&t.dicr&&(t.dicr|=3221225472,cpu.istat|=8),psx.unsetEvent(e)},rd08r10f6:function(){return t.dicr>>16&255},rd16r10f0:function(){return 65535&t.dpcr},rd32r10f0:function(){return t.dpcr},rd32r10f4:function(){return 2147483647&t.dicr},wr32r10f0:function(e){t.dpcr=e},wr08r10f6:function(e){e=e<<16|65535&t.dicr,t.dicr=t.dicr&~(2130706432&e|16777215)|16777215&e},wr32r10f4:function(e){t.dicr=t.dicr&~(2130706432&e|16777215)|16777215&e},wr32r1088:function(e){if(this.r1088=e,8&t.dpcr){let t=10;switch(e){case 0:break;case 16777729:t=mdc.dmaTransferMode0201(this.r1080,this.r1084),this.r1080n=this.r1080+(t<<2);break;default:abort("mdi-ctrl:"+hex(e))}psx.setEvent(this.eventDMA0,272*t/256>>>0)}else this.r1088&=4278190079},wr32r1098:function(e){if(this.r1098=e,128&t.dpcr){let t=10;switch(e){case 0:break;case 16777728:t=mdc.dmaTransferMode0200(this.r1090,this.r1094),this.r1090n=this.r1090+(t<<2);break;default:abort("mdo-ctrl:"+hex(e))}}else this.r1098&=4278190079},wr32r10a8:function(e){if(this.r10a8=e,2048&t.dpcr){let t=10;switch(e){case 0:case 1:case 1025:break;case 16777728:t=gpu.dmaTransferMode0200(this.r10a0,this.r10a4)||10,this.r10a0n=this.r10a0+(t<<2);break;case 16777729:t=gpu.dmaTransferMode0201(this.r10a0,this.r10a4)||10,this.r10a0n=this.r10a0+(t<<2);break;case 16778241:t=gpu.dmaTransferMode0401(this.r10a0,this.r10a4)||10,this.r10a0n=16777215;break;default:abort("gpu-ctrl:"+hex(e))}psx.setEvent(this.eventDMA2,272*t/256>>>0)}else this.r10a8&=4278190079},wr32r10b8:function(e){if(this.r10b8=e,32768&t.dpcr){let t=10;switch(e){case 0:break;case 285212672:case 289407232:t=cdr.dmaTransferMode0000(this.r10b0,this.r10b4),this.r10b0n=this.r10b0+(t<<2);break;default:abort("cd-ctrl:"+hex(e))}psx.setEvent(this.eventDMA3,10240*t/256>>>0)}else this.r10b8&=4278190079},wr32r10c8:function(e){if(this.r10c8=e,524288&t.dpcr){let t=10;switch(e){case 16777216:case 16777728:t=spu.dmaTransferMode0200(this.r10c0,this.r10c4),this.r10c0n=this.r10c0+(t<<2);break;case 16777217:case 16777729:t=spu.dmaTransferMode0201(this.r10c0,this.r10c4),this.r10c0n=this.r10c0+(t<<2);break;default:abort("spu-ctrl:"+hex(e))}psx.setEvent(this.eventDMA4,1056*t/256>>>0)}else this.r10c8&=4278190079},wr32r10e8:function(e){if(this.r10e8=1342177282&e|2,134217728&t.dpcr){let t=10;switch(this.r10e8){case 2:this.r10e0n=this.r10e0=map[(33554431&this.r10e0)>>2];break;case 268435458:case 1342177282:t=gpu.dmaLinkedListMode0002(this.r10e0,this.r10e4),this.r10e0n=16777215;break;default:abort("otc-ctrl:"+hex(e)+" "+hex(this.r10e8))}psx.setEvent(this.eventDMA6,272*t/256>>>0)}else this.r10e8&=4278190079}};e.dma=Object.seal(t)})(window),(e=>{"use strict";const t={cause:0,cop:new Int32Array(32),cycles:0,epc:0,gpr:new Int32Array(32),hi:0,imask:0,istat:0,icurr:0,lo:0,pc:0,sr:0,forceWriteBits:0,getCtrl:function(e){switch(e){case 12:return this.sr>>0;case 13:return this.cause>>0;case 14:return this.epc>>0;case 15:return 2;default:return console.warn("getCtrl:"+e),this.cop[e]}},setCtrl:function(e,t){switch(this.cop[e]=t>>0,e){case 3:case 5:case 6:case 7:case 9:case 11:break;case 12:this.sr=t,this.forceWriteBits=65536&t?33554428:0;break;case 13:this.cause=4294966527&this.cause,this.cause|=768&t;break;default:cons1ole.warn("setCtrl:"+e)}},rfe:function(){this.sr=-16&this.sr|this.sr>>2&15},lwl:function(e,t){var r=memRead32(-4&t&33554431);switch(3&t){case 0:this.gpr[e]=16777215&this.gpr[e]|r<<24;break;case 1:this.gpr[e]=65535&this.gpr[e]|r<<16;break;case 2:this.gpr[e]=255&this.gpr[e]|r<<8;break;case 3:this.gpr[e]=0&this.gpr[e]|r<<0}},lwr:function(e,t){var r=memRead32(-4&t&33554431);switch(3&t){case 0:this.gpr[e]=0&this.gpr[e]|r>>>0;break;case 1:this.gpr[e]=4278190080&this.gpr[e]|r>>>8;break;case 2:this.gpr[e]=4294901760&this.gpr[e]|r>>>16;break;case 3:this.gpr[e]=4294967040&this.gpr[e]|r>>>24}},swl:function(e,t){var r=memRead32(-4&t&33554431)>>>0;switch(3&t){case 0:r=4294967040&r|this.gpr[e]>>>24;break;case 1:r=4294901760&r|this.gpr[e]>>>16;break;case 2:r=4278190080&r|this.gpr[e]>>>8;break;case 3:r=0&r|this.gpr[e]>>>0}memWrite32(-4&t&33554431,r)},swr:function(e,t){var r=memRead32(-4&t&33554431)>>>0;switch(3&t){case 0:r=0&r|this.gpr[e]<<0;break;case 1:r=255&r|this.gpr[e]<<8;break;case 2:r=65535&r|this.gpr[e]<<16;break;case 3:r=16777215&r|this.gpr[e]<<24}memWrite32(-4&t&33554431,r)},neg:function(e){var t=e>>0&65535,r=e>>16&65535,s=1+(65535&~t);return t=65535&s,(r=65535&(s=(65535&~r)+(s>>>16)))<<16|t},mult:function(e,t){t>>=0;var r=0;if((e>>=0)<0&&(r^=1,e=this.neg(e)),t<0&&(r^=1,t=this.neg(t)),this.multu(e,t),1===r){var s=this.lo>>>0&65535,a=this.lo>>>16&65535,i=this.hi>>>0&65535,n=this.hi>>>16&65535,c=1+(65535&~s);s=65535&c,a=65535&(c=(65535&~a)+(c>>>16)),i=65535&(c=(65535&~i)+(c>>>16)),n=65535&(c=(65535&~n)+(c>>>16)),this.hi=(n<<16|i)>>0,this.lo=(a<<16|s)>>>0}},multu:function(e,t){var r=65535&(e>>>=0),s=e>>>16,a=65535&(t>>>=0),i=t>>>16,n=0,c=0,o=0,h=0;o+=(h+=r*a)>>>16,h&=65535,c+=(o+=r*i)>>>16,o&=65535,c+=(o+=s*a)>>>16,o&=65535,n+=(c+=s*i)>>>16,c&=65535,this.hi=(n<<16|c)>>>0,this.lo=(o<<16|h)>>>0},div:function(e,t){0===t?e>>0>=0?(this.hi=e,this.lo=4294967295):(this.hi=e,this.lo=1):t>>0==-1&&e>>>0==2147483648?(this.hi=0,this.lo=-2147483648):(this.hi=(e>>0)%(t>>0)>>0,this.lo=(e>>0)/(t>>0)>>0)},divu:function(e,t){0===t?(this.hi=e,this.lo=4294967295):(this.hi=(e>>>0)%(t>>>0)>>>0,this.lo=(e>>>0)/(t>>>0)>>>0)}};function r(e,r){return t.sr=-64&t.sr|t.sr<<2&63,t.cause=-125&t.cause|e,t.epc=r,vector}e.cpu=Object.seal(t),e.cpuException=r,e.cpuInterrupt=function(e){if(1==(1&t.sr)){let s=768&t.cause,a=768&t.sr;if(0!=(s&a))return r(s&a,e.pc);if(1024==(1024&t.sr)&&t.istat&t.imask)return r(1024,e.pc)}return e}})(window),(e=>{"use strict";const t=new Int32Array(4),r=new Int32Array(4),s=new Int32Array(4),a=new Int32Array(9),i=new Int32Array(9),n=new Int32Array(9),c=new Int32Array(9),o=new Int32Array(3),h=new Int32Array(3),u=new Int32Array(3),d=new Int32Array(4),l=new Float64Array(4),f=new Float64Array(4),p=new Int32Array(64),m=new Int32Array(32),g=Object.seal({sx:new Int32Array(3),sy:new Int32Array(3),sz:new Int32Array(4),zsf3:0,zsf4:0,lzcr:0,sf:0,lm:0,lim:function(e,t,r,s,a){return e<t?(p[63]|=m[r],t):e>s?(p[63]|=m[a],s):e},countLeadingZeros:function(e){if(2147483648&e&&(e^=4294967295),0===e)this.lzcr=32;else{for(var t=31;0==(e&1<<t)&&t>=0;--t);this.lzcr=31-t}},get:function(e){switch(e){case 0:return p[e];case 1:return t[3]<<16>>16;case 2:return p[e];case 3:return r[3]<<16>>16;case 4:return p[e];case 5:return s[3]<<16>>16;case 6:return p[e];case 7:return p[e]<<16>>>16;case 8:return l[0]<<16>>16;case 9:return l[1]<<16>>16;case 10:return l[2]<<16>>16;case 11:return l[3]<<16>>16;case 12:return 65535&this.sx[0]|this.sy[0]<<16;case 13:return 65535&this.sx[1]|this.sy[1]<<16;case 14:case 15:return 65535&this.sx[2]|this.sy[2]<<16;case 16:return this.sz[0]<<16>>>16;case 17:return this.sz[1]<<16>>>16;case 18:return this.sz[2]<<16>>>16;case 19:return this.sz[3]<<16>>>16;case 20:return d[0];case 21:return d[1];case 22:return d[2];case 23:return p[e];case 24:return f[0];case 25:return f[1];case 26:return f[2];case 27:return f[3];case 29:var a=0;return a|=l[1]>>7<<0,a|=l[2]>>7<<5,a|=l[3]>>7<<10;case 30:return p[e];case 31:return this.lzcr;case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return p[e];case 58:return p[e]<<16>>16;case 59:case 60:case 61:case 62:case 63:return p[e];default:abort("get gte.r"+hex(e,2)+" not yet implemented")}},set:function(e,c){switch(p[e]=c,e){case 0:t[1]=c<<16>>16,t[2]=c<<0>>16;break;case 1:t[3]=c<<16>>16;break;case 2:r[1]=c<<16>>16,r[2]=c<<0>>16;break;case 3:r[3]=c<<16>>16;break;case 4:s[1]=c<<16>>16,s[2]=c<<0>>16;break;case 5:s[3]=c<<16>>16;break;case 6:d[3]=c;break;case 7:break;case 8:l[0]=c<<16>>16;break;case 9:l[1]=c<<16>>16;break;case 10:l[2]=c<<16>>16;break;case 11:l[3]=c<<16>>16;break;case 12:this.sx[0]=c<<16>>16,this.sy[0]=c<<0>>16;break;case 13:this.sx[1]=c<<16>>16,this.sy[1]=c<<0>>16;break;case 14:this.sx[2]=c<<16>>16,this.sy[2]=c<<0>>16;break;case 15:this.sx[0]=this.sx[1],this.sy[0]=this.sy[1],this.sx[1]=this.sx[2],this.sy[1]=this.sy[2],this.sx[2]=c<<16>>16,this.sy[2]=c<<0>>16;break;case 16:this.sz[0]=c<<16>>>16;break;case 17:this.sz[1]=c<<16>>>16;break;case 18:this.sz[2]=c<<16>>>16;break;case 19:this.sz[3]=c<<16>>>16;break;case 20:d[0]=c;break;case 21:d[1]=c;break;case 22:d[2]=c;break;case 23:break;case 24:f[0]=c<<0>>0;break;case 25:f[1]=c<<0>>0;break;case 26:f[2]=c<<0>>0;break;case 27:f[3]=c<<0>>0;break;case 28:l[1]=(31&c)<<7,l[2]=(992&c)<<2,l[3]=(31744&c)>>3;break;case 29:break;case 30:this.countLeadingZeros(c);break;case 31:break;case 32:n[0]=c<<16>>16,n[1]=c<<0>>16;break;case 33:n[2]=c<<16>>16,n[3]=c<<0>>16;break;case 34:n[4]=c<<16>>16,n[5]=c<<0>>16;break;case 35:n[6]=c<<16>>16,n[7]=c<<0>>16;break;case 36:p[e]=n[8]=c<<16>>16;break;case 37:u[0]=c<<0>>0;break;case 38:u[1]=c<<0>>0;break;case 39:u[2]=c<<0>>0;break;case 40:a[0]=c<<16>>16,a[1]=c<<0>>16;break;case 41:a[2]=c<<16>>16,a[3]=c<<0>>16;break;case 42:a[4]=c<<16>>16,a[5]=c<<0>>16;break;case 43:a[6]=c<<16>>16,a[7]=c<<0>>16;break;case 44:p[e]=a[8]=c<<16>>16;break;case 45:o[0]=c<<0>>0;break;case 46:o[1]=c<<0>>0;break;case 47:o[2]=c<<0>>0;break;case 48:i[0]=c<<16>>16,i[1]=c<<0>>16;break;case 49:i[2]=c<<16>>16,i[3]=c<<0>>16;break;case 50:i[4]=c<<16>>16,i[5]=c<<0>>16;break;case 51:i[6]=c<<16>>16,i[7]=c<<0>>16;break;case 52:p[e]=i[8]=c<<16>>16;break;case 53:h[0]=c<<0>>0;break;case 54:h[1]=c<<0>>0;break;case 55:h[2]=c<<0>>0;break;case 56:case 57:p[e]=c<<0>>0;break;case 58:p[e]=c<<16>>>16;break;case 59:p[e]=c<<16>>16;break;case 60:p[e]=c<<0>>0;break;case 61:p[e]=this.zsf3=c<<16>>16;break;case 62:p[e]=this.zsf4=c<<16>>16;break;case 63:p[e]=2147479552&c,2139611136&p[e]&&(p[e]|=2147483648);break;default:abort("gte.set(r"+hex(e,2)+", "+hex(c)+") not yet implemented")}},limit:function(e){const t=e?0:-32768;l[1]=this.lim(f[1],t,24,32767,24),l[2]=this.lim(f[2],t,23,32767,23),l[3]=this.lim(f[3],t,22,32767,22)},depthCue:function(){const e=this.sf?4096:1;l[1]=(4096*h[0]-f[1])/e,l[2]=(4096*h[1]-f[2])/e,l[3]=(4096*h[2]-f[3])/e,l[1]=this.lim(l[1],-32768,24,32767,24),l[2]=this.lim(l[2],-32768,23,32767,23),l[3]=this.lim(l[3],-32768,22,32767,22)},interpolate:function(){const e=this.sf?4096:1;f[1]=(f[1]+l[1]*l[0])/e,f[2]=(f[2]+l[2]*l[0])/e,f[3]=(f[3]+l[3]*l[0])/e,this.limit(this.lm)},transform:function(e,t,r){const s=this.sf?4096:1;f[1]=(4096*e[0]+t[0]*r[1]+t[1]*r[2]+t[2]*r[3])/s,f[2]=(4096*e[1]+t[3]*r[1]+t[4]*r[2]+t[5]*r[3])/s,f[3]=(4096*e[2]+t[6]*r[1]+t[7]*r[2]+t[8]*r[3])/s,this.limit(this.lm)},updateColorFifo:function(){const e=d[3]>>>24,t=this.lim(f[1]/16,0,21,255,21),r=this.lim(f[2]/16,0,20,255,20),s=this.lim(f[3]/16,0,19,255,19);d[0]=d[1],d[1]=d[2],d[2]=e<<24|s<<16|r<<8|t<<0},avsz3:function(){const e=this.sz,t=this.zsf3;f[0]=t*(e[1]+e[2]+e[3]),f[0]>2147483647&&(p[63]|=m[16]),f[0]<-2147483648&&(p[63]|=m[15]),p[7]=g.lim(f[0]/4096,0,18,65535,18)},avsz4:function(){const e=this.sz,t=this.zsf4;f[0]=t*(e[0]+e[1]+e[2]+e[3]),f[0]>2147483647&&(p[63]|=m[16]),f[0]<-2147483648&&(p[63]|=m[15]),p[7]=g.lim(f[0]/4096,0,18,65535,18)},cc:function(){const e=this.sf?4096:1;this.transform(o,i,l),f[1]=(d[3]>>0&255)*l[1]*16,f[2]=(d[3]>>8&255)*l[2]*16,f[3]=(d[3]>>16&255)*l[3]*16,f[1]=f[1]/e,f[2]=f[2]/e,f[3]=f[3]/e,this.limit(this.lm),this.updateColorFifo()},cdp:function(){const e=this.sf?4096:1;this.transform(o,i,l),f[1]=(d[3]>>0&255)*l[1]*16,f[2]=(d[3]>>8&255)*l[2]*16,f[3]=(d[3]>>16&255)*l[3]*16,this.depthCue(),this.interpolate(),f[1]=f[1]/e,f[2]=f[2]/e,f[3]=f[3]/e,this.limit(this.lm),this.updateColorFifo()},dcpl:function(){f[1]=(d[3]>>0&255)*l[1]*16,f[2]=(d[3]>>8&255)*l[2]*16,f[3]=(d[3]>>16&255)*l[3]*16,this.depthCue(),this.interpolate(),this.updateColorFifo()},dpcs:function(e){f[1]=65536*(e>>0&255),f[2]=65536*(e>>8&255),f[3]=65536*(e>>16&255),this.depthCue(),this.interpolate(),this.updateColorFifo()},gpf:function(){f[1]=0,f[2]=0,f[3]=0,this.interpolate(),this.updateColorFifo()},gpl:function(){const e=this.sf?4096:1;f[1]=f[1]*e,f[2]=f[2]*e,f[3]=f[3]*e,this.interpolate(),this.updateColorFifo()},intpl:function(){f[1]=4096*l[1],f[2]=4096*l[2],f[3]=4096*l[3],this.depthCue(),this.interpolate(),this.updateColorFifo()},mvmva:function(e){switch(e>>17&3){case 0:var d=n;break;case 1:d=a;break;case 2:d=i;break;case 3:d=c}switch(e>>15&3){case 0:var f=t;break;case 1:f=r;break;case 2:f=s;break;case 3:f=l}switch(e>>13&3){case 0:var p=u;break;case 1:p=o;break;case 2:p=h;abort("faulty");break;case 3:p=c}this.transform(p,d,f)},nccs:function(e){const t=this.sf?4096:1;this.transform(c,a,e),this.transform(o,i,l),f[1]=(d[3]>>0&255)*l[1]*16,f[2]=(d[3]>>8&255)*l[2]*16,f[3]=(d[3]>>16&255)*l[3]*16,f[1]=f[1]/t,f[2]=f[2]/t,f[3]=f[3]/t,this.limit(this.lm),this.updateColorFifo()},ncds:function(e){this.transform(c,a,e),this.transform(o,i,l),f[1]=(d[3]>>0&255)*l[1]*16,f[2]=(d[3]>>8&255)*l[2]*16,f[3]=(d[3]>>16&255)*l[3]*16,this.depthCue(),this.interpolate(),this.updateColorFifo()},nclip:function(){const e=this.sx,t=this.sy;f[0]=e[0]*(t[1]-t[2])+e[1]*(t[2]-t[0])+e[2]*(t[0]-t[1]),f[0]>2147483647&&(p[63]|=m[16]),f[0]<-2147483648&&(p[63]|=m[15])},ncs:function(e){this.transform(c,a,e),this.transform(o,i,l),this.updateColorFifo()},op:function(){const e=this.sf?4096:1;f[1]=(l[3]*n[4]-l[2]*n[8])/e,f[2]=(l[1]*n[8]-l[3]*n[0])/e,f[3]=(l[2]*n[0]-l[1]*n[4])/e,this.limit(this.lm)},rtps:function(e){const t=65535&p[58],r=p[56],s=p[57],a=p[59],i=p[60],c=this.sx,o=this.sy,h=this.sz,d=this.sf?4096:1;f[1]=(4096*u[0]+n[0]*e[1]+n[1]*e[2]+n[2]*e[3])/d,f[1]>8796093022207&&(p[63]|=m[30]),f[1]<-8796093022208&&(p[63]|=m[27]),f[2]=(4096*u[1]+n[3]*e[1]+n[4]*e[2]+n[5]*e[3])/d,f[2]>8796093022207&&(p[63]|=m[29]),f[2]<-8796093022208&&(p[63]|=m[26]),f[3]=(4096*u[2]+n[6]*e[1]+n[7]*e[2]+n[8]*e[3])/d,f[3]>8796093022207&&(p[63]|=m[28]),f[3]<-8796093022208&&(p[63]|=m[25]),this.limit(this.lm),c[0]=c[1],c[1]=c[2],o[0]=o[1],o[1]=o[2],h[0]=h[1],h[1]=h[2],h[2]=h[3];let g=f[3]/(this.sf?1:4096);h[3]=this.lim(g,0,18,65535,18);let x=131072;(x=(131072*t/h[3]+1)/2)>131071&&(p[63]|=m[17],x=131071),f[0]=x*l[1]+r,c[2]=f[0]/65536,f[0]>2147483647&&(p[63]|=m[16]),f[0]<-2147483648&&(p[63]|=m[15]),f[0]=x*l[2]+s,o[2]=f[0]/65536,f[0]>2147483647&&(p[63]|=m[16]),f[0]<-2147483648&&(p[63]|=m[15]),f[0]=x*a+i,l[0]=f[0]/4096,f[0]>2147483647&&(p[63]|=m[16]),f[0]<-2147483648&&(p[63]|=m[15]),c[2]=this.lim(c[2],-1024,14,1023,14),o[2]=this.lim(o[2],-1024,13,1023,13),l[0]=this.lim(l[0],0,12,4096,12)},sqr:function(){const e=this.sf?4096:1;f[1]=l[1]*l[1]/e,f[2]=l[2]*l[2]/e,f[3]=l[3]*l[3]/e,this.limit(this.lm)},command:function(e){switch(this.sf=e>>19&1,this.lm=e>>10&1,p[63]=0,63&e){case 1:this.rtps(t);break;case 6:this.nclip();break;case 12:this.op();break;case 16:this.dpcs(d[3]);break;case 17:this.intpl();break;case 18:this.mvmva(e);break;case 19:this.ncds(t);break;case 20:this.cdp();break;case 22:this.ncds(t),this.ncds(r),this.ncds(s);break;case 27:this.nccs(t);break;case 28:this.cc();break;case 30:this.ncs(t);break;case 32:this.ncs(t),this.ncs(r),this.ncs(s);break;case 40:this.sqr();break;case 41:this.dcpl();break;case 42:this.dpcs(d[0]),this.dpcs(d[0]),this.dpcs(d[0]);break;case 45:this.avsz3();break;case 46:this.avsz4();break;case 48:this.rtps(t),this.rtps(r),this.rtps(s);break;case 61:this.gpf();break;case 62:this.gpl();break;case 63:this.nccs(t),this.nccs(r),this.nccs(s);break;default:abort("gte.$"+hex(e,5)+" not yet implemented")}},cycles:function(e){switch(63&e){case 1:return 15;case 6:return 8;case 12:return 6;case 16:case 17:case 18:return 8;case 19:return 19;case 20:return 13;case 22:return 44;case 27:return 17;case 28:return 11;case 30:return 14;case 32:return 30;case 40:return 5;case 41:return 8;case 42:return 17;case 45:return 5;case 46:return 6;case 48:return 23;case 61:case 62:return 5;case 63:return 39;default:return abort("gte.$"+hex(e,5)+" has no cycles"),5}}});for(var x=0;x<=31;++x)m[x]=1<<x;for(x=23;x<=30;++x)m[x]|=2147483648;for(x=13;x<=18;++x)m[x]|=2147483648;e.gte=Object.seal(g)})(window),(e=>{"use strict";var t=[1,1,3,1,1,1,0,0,1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,7,7,7,7,5,5,5,5,9,9,9,9,6,6,6,6,9,9,9,9,8,8,8,8,12,12,12,12,3,3,3,3,0,0,0,0,5,5,5,5,6,6,6,6,4,4,4,4,0,0,0,0,7,7,7,7,9,9,9,9,3,3,3,3,4,4,4,4,2,2,2,2,0,0,0,0,2,2,2,2,3,3,3,3,2,2,2,2,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1];const r={bbb:0,bbbdata:new Uint16Array(2097152),dispB:256,dispL:0,dispR:0,dispT:16,dispX:0,dispY:0,dmaBuffer:new Int32Array(1024),dmaIndex:0,drawAreaX1:0,drawAreaX2:0,drawAreaY1:0,drawAreaY2:0,drawOffsetX:0,drawOffsetY:0,handlers:[],heights:[1,2,1,2],hline:0,img:{w:0,h:0,x:0,y:0,index:0,pixelCount:0,buffer:new Uint16Array(524288)},info:new Uint32Array(16),maxheights:[240,480,256,512],maxwidths:[256,368,320,368,512,368,640,368],packetSize:0,result:2,status:343941120,tp:0,transferTotal:0,twin:0,tx:0,txflip:0,ty:0,tyflip:0,widths:[10,7,8,7,5,7,4,7],frame:0,internalFrame:0,updated:!1,cyclesToDotClock:function(e){switch(r.status>>16&7){case 0:return 11*e/7/10;case 1:return 11*e/7/7;case 2:return 11*e/7/8;case 3:return 11*e/7/7;case 4:return 11*e/7/5;case 5:return 11*e/7/7;case 6:return 11*e/7/4;case 7:return 11*e/7/7}},getDisplayArea:function(){if(r.status>>20&1)var e=r.dispT%256,t=Math.min(r.dispB,314);else e=r.dispT%240,t=Math.min(r.dispB,263);var s=t-e,a=r.dispR-r.dispL,i=r.maxwidths[r.status>>16&7],n=a/r.widths[r.status>>16&7];n=Math.min(i,n+2&-4);var c=r.maxheights[r.status>>19&3],o=r.heights[r.status>>19&3]*s;return o=Math.min(c,o),{x:r.dispX,y:r.dispY,w:n,h:o}},onScanLine:function(e){r.hline=e;let t=r.status&1<<22,s=!!(r.status>>20&1),a=s?314:263,i=r.dispB-r.dispT>>1,n=s?163:136,c=n-i,o=n+i;if(o>a&&(o=a),c<0&&(c=0),t)1==(1&r.frame)?r.status|=2147483648:r.status&=2147483647;else{1==(1&r.hline+(1&r.frame))?r.status|=2147483648:r.status&=2147483647}r.hline===o&&renderer.onVBlankBegin(),r.hline===c&&renderer.onVBlankEnd(),(r.hline>=o||r.hline<c)&&(r.status&=2147483647),++r.hline>=a&&(r.updated&&++r.internalFrame,r.updated=!1,cpu.istat|=1,r.hline=0,++r.frame)},rd32r1810:function(){return 134217728&r.rR1814&&abort("gpu.rd32r1810 not implemented"),r.result},rd32r1814:function(){return r.status},wr32r1810:function(e){if(268435456&r.status){if(r.dmaBuffer[r.dmaIndex++]=e,1===r.dmaIndex&&(r.packetSize=t[e>>>24]),r.dmaIndex===r.packetSize){var s=r.dmaBuffer[0]>>>24;r.handlers[s].call(this,r.dmaBuffer),r.dmaIndex=0}}else{if(r.img.buffer[r.img.index++]=e>>>0&65535,--r.transferTotal<=0)return void r.imgTransferComplete(r.img);if(r.img.buffer[r.img.index++]=e>>>16&65535,--r.transferTotal<=0)return void r.imgTransferComplete(r.img)}},wr32r1814:function(e){switch(e>>>24){case 0:r.status=343941120,r.dmaIndex=0;break;case 1:r.status|=1879048192,r.dmaIndex=0;break;case 2:break;case 3:r.status&=4286578687,r.status|=(1&e)<<23;break;case 4:r.status&=2684354559,r.status|=(3&e)<<29;break;case 5:r.dispX=e>>0&1023,r.dispY=e>>10&511;break;case 6:r.dispL=e>>0&4095,r.dispR=e>>12&4095;break;case 7:r.dispT=e>>0&1023,r.dispB=e>>10&1023;break;case 8:r.status&=4286644223,r.status|=(63&e)<<17,r.status|=64&e?65536:0;break;case 16:switch(15&e){case 2:case 3:case 4:case 5:case 7:case 8:r.result=r.info[15&e]}break;case 64:break;default:console.warn("gpu.cmnd"+hex(e>>>24,2))}r.updateTexturePage()},invalidPacketHandler:function(e){},updateTexturePage:function(e){switch(void 0!==e&&(r.status=-2560&r.status|2559&e),r.tx=(r.status>>>0&15)<<6,r.ty=(r.status>>>4&1)<<8,r.tp=r.status>>>7&3,r.tp){case 0:r.tx<<=2;break;case 1:r.tx<<=1;break;case 2:case 3:r.tx*=1}},handlePacket00:function(e){},handlePacket01:function(e){r.status=-134217729&(268435456|r.status)},handlePacket02:function(e){renderer.fillRectangle(e)},handlePacket03:function(e){},handlePacket04:function(e){},handlePacket05:function(e){},handlePacket08:function(e){},handlePacket09:function(e){},handlePacket0D:function(e){},handlePacket20:function(e){renderer.drawTriangle(e,0,1,0,2,0,3)},handlePacket24:function(e){r.updateTexturePage(e[4]>>>16),renderer.drawTriangle(e,0,1,0,3,0,5,r.tx,r.ty,2,4,6,e[2]>>>16)},handlePacket28:function(e){renderer.drawTriangle(e,0,1,0,2,0,3),renderer.drawTriangle(e,0,2,0,3,0,4)},handlePacket2C:function(e){r.updateTexturePage(e[4]>>>16),renderer.drawTriangle(e,0,1,0,3,0,5,r.tx,r.ty,2,4,6,e[2]>>>16),renderer.drawTriangle(e,0,3,0,5,0,7,r.tx,r.ty,4,6,8,e[2]>>>16)},handlePacket30:function(e){renderer.drawTriangle(e,0,1,2,3,4,5)},handlePacket34:function(e){r.updateTexturePage(e[5]>>>16),renderer.drawTriangle(e,0,1,3,4,6,7,r.tx,r.ty,2,5,8,e[2]>>>16)},handlePacket38:function(e){renderer.drawTriangle(e,0,1,2,3,4,5),renderer.drawTriangle(e,2,3,4,5,6,7)},handlePacket3C:function(e){r.updateTexturePage(e[5]>>>16),renderer.drawTriangle(e,0,1,3,4,6,7,r.tx,r.ty,2,5,8,e[2]>>>16),renderer.drawTriangle(e,3,4,6,7,9,10,r.tx,r.ty,5,8,11,e[2]>>>16)},handlePacket40:function(e){renderer.drawLine(e,0,1,0,2)},handlePacket48:function(e,t){for(var r=2;r<t;r+=1)renderer.drawLine(e,0,r-1,0,r)},handlePacket50:function(e){renderer.drawLine(e,0,1,2,3)},handlePacket58:function(e,t){for(var r=3;r<t;r+=2)renderer.drawLine(e,r-3,r-2,r-1,r)},handlePacket60:function(e){renderer.drawRectangle([e[0],e[1],e[2]],0,0,0)},handlePacket64:function(e){var t=e[2]>>>0&255,r=e[2]>>>8&255;renderer.drawRectangle([e[0],e[1],e[3]],t,r,e[2]>>>16)},handlePacket68:function(e){renderer.drawRectangle([e[0],e[1],65537],0,0,0)},handlePacket70:function(e){renderer.drawRectangle([e[0],e[1],524296],0,0,0)},handlePacket74:function(e){var t=e[2]>>>0&255,r=e[2]>>>8&255;renderer.drawRectangle([e[0],e[1],524296],t,r,e[2]>>>16)},handlePacket78:function(e){renderer.drawRectangle([e[0],e[1],1048592],0,0,0)},handlePacket7C:function(e){var t=e[2]>>>0&255,r=e[2]>>>8&255;renderer.drawRectangle([e[0],e[1],1048592],t,r,e[2]>>>16)},handlePacket80:function(e){if(e[1]!==e[2]){var t=e[1]>>0,r=e[1]>>16,s=e[2]>>0,a=e[2]>>16,i=e[3]>>0,n=e[3]>>16;s&=1023,a&=511,t&=1023,r&=511,(i=1+(i-1&1023))*(n=1+(n-1&511))&&renderer.moveImage(t,r,s,a,i,n)}},handlePacketA0:function(e){r.status&=-268435457;var t=e[1]<<16>>>16,s=e[1]<<0>>>16,a=e[2]<<16>>>16,i=e[2]<<0>>>16;r.img.w=1+(a-1&1023),r.img.h=1+(i-1&511),r.img.x=1023&t,r.img.y=511&s,r.img.index=0,r.transferTotal=r.img.w*r.img.h+1&-2,r.img.pixelCount=r.transferTotal},handlePacketC0:function(e){r.status|=134217728;var t=e[1]<<16>>>16,s=e[1]<<0>>>16,a=e[2]<<16>>>16,i=e[2]<<0>>>16;r.img.w=1+(a-1&1023),r.img.h=1+(i-1&511),r.img.x=1023&t,r.img.y=511&s,r.img.index=0,r.transferTotal=r.img.w*r.img.h+1&-2,r.img.pixelCount=r.transferTotal,renderer.loadImage(r.img.x,r.img.y,r.img.w,r.img.h,r.img.buffer)},handlePacketE1:function(e){r.status=4294965248&r.status|2047&e[0],r.txflip=e[0]>>>12&1,r.tyflip=e[0]>>>13&1,r.updateTexturePage()},handlePacketE2:function(e){r.info[2]=1048575&e[0];var t=(e[0]>>0&31)<<3,s=(e[0]>>5&31)<<3,a=(e[0]>>10&31)<<3,i=(e[0]>>15&31)<<3;r.twin=(t<<0)+(s<<8)+(a<<16)+(i<<24)},handlePacketE3:function(e){r.info[3]=1048575&e[0],r.drawAreaX1=e[0]<<22>>>22,r.drawAreaY1=e[0]<<12>>>22,renderer.setDrawAreaTL(r.drawAreaX1,r.drawAreaY1)},handlePacketE4:function(e){r.info[4]=1048575&e[0],r.drawAreaX2=e[0]<<22>>>22,r.drawAreaY2=e[0]<<12>>>22,renderer.setDrawAreaBR(r.drawAreaX2,r.drawAreaY2)},handlePacketE5:function(e){r.info[5]=4194303&e[0],r.drawOffsetX=e[0]<<21>>21,r.drawOffsetY=e[0]<<11>>22,renderer.setDrawAreaOF(r.drawOffsetX,r.drawOffsetY)},handlePacketE6:function(e){r.status&=4294961151,r.status|=(3&e[0])<<11},imgTransferComplete:function(e){renderer.storeImage(r.img),r.status|=268435456},dmaTransferMode0200:function(e,t){if(!e)return;var s=(t>>16)*(65535&t)<<1;clearCodeCache(e,s<<1),r.transferTotal-=s;const a=r.img;for(;--s>=0;){const t=r.img.buffer[a.index++];map16[(2097151&e)>>>1]=t,e+=2}return r.transferTotal<=0&&(r.status&=-134217729),(t>>16)*(65535&t)},dmaTransferMode0201:function(e,t){if(!e)return;if(0==(-4&e))return(t>>16)*(65535&t);var s=(t>>16)*(65535&t)<<1;r.transferTotal-=s;const a=r.img;for(;--s>=0;){const t=map16[(2097151&e)>>>1];a.buffer[a.index++]=t,e+=2}return r.transferTotal<=0&&(r.imgTransferComplete(r.img),r.updated=!0),(t>>16)*(65535&t)},dmaTransferMode0401:function(e,s){if(!e)return;if(0==(-4&e))return(s>>16)*(65535&s);const a=65535&++this.bbb,i=this.bbbdata;var n=r.dmaBuffer;let c=0;for(;;){if(i[e&=2097151]===a)return c;i[e]=a;var o=map[e>>2],h=o>>>24,u=16777215&o;for(e+=4,++c;h>0;){if(i[e]===a)return c;i[e]=a;const s=map[e>>2]>>>24;if(0===t[s]){if(e+=4,++c,h--,255===s)continue;return console.log(`unknown packetId: $${hex(s,2)}`),c}if(s>=72&&s<80||s>=88&&s<96){let t=0;for(;t<256;++t){const r=map[e>>2];if(e+=4,--h,++c,1342197760==(4026593280&r))break;n[t]=r}r.handlers[s].call(this,n,t),r.updated=!0}else{const a=t[s];for(let t=0;t<a;++t)n[t]=map[e>>2],e+=4;r.handlers[s].call(this,n,a),r.updated=!0,h-=a,c+=a}}if(!u||16777215==u)break;e=u}return c},dmaLinkedListMode0002:function(e,t){if(!e)return;if(0==(-4&e))return(t>>16)*(65535&t);t>=65536&&abort("unexpected blck size"),0===t&&(t=65536),e&=2097151;let r=t;for(;--t>=1;)map[e>>2]=e-4&2097151,e=e-4&2097151;return map[e>>2]=16777215,clearCodeCache(e,r<<2),r}};r.handlePacket21=r.handlePacket20,r.handlePacket22=r.handlePacket20,r.handlePacket23=r.handlePacket20,r.handlePacket25=r.handlePacket24,r.handlePacket26=r.handlePacket24,r.handlePacket27=r.handlePacket24,r.handlePacket29=r.handlePacket28,r.handlePacket2A=r.handlePacket28,r.handlePacket2B=r.handlePacket28,r.handlePacket2D=r.handlePacket2C,r.handlePacket2E=r.handlePacket2C,r.handlePacket2F=r.handlePacket2C,r.handlePacket31=r.handlePacket30,r.handlePacket32=r.handlePacket30,r.handlePacket33=r.handlePacket30,r.handlePacket35=r.handlePacket34,r.handlePacket36=r.handlePacket34,r.handlePacket37=r.handlePacket34,r.handlePacket39=r.handlePacket38,r.handlePacket3A=r.handlePacket38,r.handlePacket3B=r.handlePacket38,r.handlePacket3D=r.handlePacket3C,r.handlePacket3E=r.handlePacket3C,r.handlePacket3F=r.handlePacket3C,r.handlePacket41=r.handlePacket40,r.handlePacket42=r.handlePacket40,r.handlePacket43=r.handlePacket40,r.handlePacket49=r.handlePacket48,r.handlePacket4A=r.handlePacket48,r.handlePacket4B=r.handlePacket48,r.handlePacket4C=r.handlePacket48,r.handlePacket4D=r.handlePacket48,r.handlePacket4E=r.handlePacket48,r.handlePacket4F=r.handlePacket48,r.handlePacket51=r.handlePacket50,r.handlePacket52=r.handlePacket50,r.handlePacket53=r.handlePacket50,r.handlePacket59=r.handlePacket58,r.handlePacket5A=r.handlePacket58,r.handlePacket5B=r.handlePacket58,r.handlePacket5C=r.handlePacket58,r.handlePacket5D=r.handlePacket58,r.handlePacket5E=r.handlePacket58,r.handlePacket5F=r.handlePacket58,r.handlePacket61=r.handlePacket60,r.handlePacket62=r.handlePacket60,r.handlePacket63=r.handlePacket60,r.handlePacket65=r.handlePacket64,r.handlePacket66=r.handlePacket64,r.handlePacket67=r.handlePacket64,r.handlePacket69=r.handlePacket68,r.handlePacket6A=r.handlePacket68,r.handlePacket6B=r.handlePacket68,r.handlePacket71=r.handlePacket70,r.handlePacket72=r.handlePacket70,r.handlePacket73=r.handlePacket70,r.handlePacket75=r.handlePacket74,r.handlePacket76=r.handlePacket74,r.handlePacket77=r.handlePacket74,r.handlePacket79=r.handlePacket78,r.handlePacket7A=r.handlePacket78,r.handlePacket7B=r.handlePacket78,r.handlePacket7D=r.handlePacket7C,r.handlePacket7E=r.handlePacket7C,r.handlePacket7F=r.handlePacket7C;for(var s=0;s<256;++s){var a="handlePacket"+hex(s,2).toUpperCase();r.handlers[s]=r[a]||r.invalidPacketHandler}for(s=129;s<159;++s)r.handlers[s]=r.handlePacket80;for(s=161;s<191;++s)r.handlers[s]=r.handlePacketA0;for(s=193;s<223;++s)r.handlers[s]=r.handlePacketC0;r.info[7]=2,r.info[8]=0,e.gpu=r})(window),(e=>{"use strict";var t={iq:new Int32Array(128),scale:new Uint8Array(768),zscan:[0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63],aanscales:[16384,22725,21407,19266,16384,12873,8867,4520,22725,31521,29692,26722,22725,17855,12299,6270,21407,29692,27969,25172,21407,16819,11585,5906,19266,26722,25172,22654,19266,15137,10426,5315,16384,22725,21407,19266,16384,12873,8867,4520,12873,17855,16819,15137,12873,10114,6967,3552,8867,12299,11585,10426,8867,6967,4799,2446,4520,6270,5906,5315,4520,3552,2446,1247],SCALERC256:function(e,t){return this.scale[384+e+t]},iqtab_reset:function(){this.iq.fill(0)},iqtab_init:function(e,t){for(let r=0;r<t;++r){const t=255&map8[(e+r&2097151)>>>0];this.iq[r]=t*this.aanscales[this.zscan[63&r]]>>12}},icdt:function(e,t){let r,s,a,i,n=t;for(let n=8;n>0;--n,t+=8){r=e[t+0]+e[t+4]>>0,s=e[t+0]-e[t+4]>>0;const n=r+(i=e[t+2]+e[t+6]>>0)>>0,c=r-i>>0,o=s+(a=(362*(a=e[t+2]-e[t+6]>>0)>>8)-i>>0)>>0,h=s-a>>0;i=e[t+3]+e[t+5]>>0,r=e[t+3]-e[t+5]>>0,s=e[t+1]+e[t+7]>>0;const u=473*((a=e[t+1]-e[t+7]>>0)-r)>>8,d=s+i>>0,l=(669*r>>8)+u-d>>0,f=(362*(s-i)>>8)-l>>0,p=(277*a>>8)-u+f>>0;e[t+0]=n+d>>5,e[t+1]=o+l>>5,e[t+2]=h+f>>5,e[t+3]=c-p>>5,e[t+4]=c+p>>5,e[t+5]=h-f>>5,e[t+6]=o-l>>5,e[t+7]=n-d>>5}t=n;for(let n=8;n>0;--n,++t){r=e[t+0]+e[t+32]>>0,s=e[t+0]-e[t+32]>>0;const n=r+(i=e[t+16]+e[t+48]>>0)>>0,c=r-i>>0,o=s+(a=(362*(a=e[t+16]-e[t+48]>>0)>>8)-i>>0)>>0,h=s-a>>0;i=e[t+24]+e[t+40]>>0,r=e[t+24]-e[t+40]>>0,s=e[t+8]+e[t+56]>>0;const u=473*((a=e[t+8]-e[t+56]>>0)-r)>>8,d=s+i>>0,l=(669*r>>8)+u-d>>0,f=(362*(s-i)>>8)-l>>0,p=(277*a>>8)-u+f>>0;e[t+0]=n+d>>0,e[t+8]=o+l>>0,e[t+16]=h+f>>0,e[t+24]=c-p>>0,e[t+32]=c+p>>0,e[t+40]=h-f>>0,e[t+48]=o-l>>0,e[t+56]=n-d>>0}},rl2blk:function(e,t){const r=this.iq;e.fill(0);let s=(2097151&t)>>>1;for(let t=0;t<6;t++){const a=t>=2?0:64,i=64*t,n=65535&map16[s++];let c=0;const o=n>>10,h=n<<22>>22;for(e[i]=r[a]*h;;){const t=65535&map16[s++];if((c+=1+(t>>10))<=63){const s=t<<22>>22,n=r[a+c]*o*s>>3;e[i+this.zscan[c]]=n}if(c>63)break}this.icdt(e,i)}return s<<1},putquadrgb15:function(e,t,s,a,i){let n,c,o,h,u=r.STP;const d=1433*a>>10,l=-351*i-728*a>>10,f=1807*i>>10,p=(2097151&e)>>>0;n=t[s+0]<<0,c=this.SCALERC256(n,d)>>>3,o=this.SCALERC256(n,l)>>>3,h=this.SCALERC256(n,f)>>>3,map16[p+0>>>1]=u|h<<10|o<<5|c,n=t[s+1]<<0,c=this.SCALERC256(n,d)>>>3,o=this.SCALERC256(n,l)>>>3,h=this.SCALERC256(n,f)>>>3,map16[p+2>>>1]=u|h<<10|o<<5|c,n=t[s+8]<<0,c=this.SCALERC256(n,d)>>>3,o=this.SCALERC256(n,l)>>>3,h=this.SCALERC256(n,f)>>>3,map16[p+32>>>1]=u|h<<10|o<<5|c,n=t[s+9]<<0,c=this.SCALERC256(n,d)>>>3,o=this.SCALERC256(n,l)>>>3,h=this.SCALERC256(n,f)>>>3,map16[p+34>>>1]=u|h<<10|o<<5|c},yuv2rgb15:function(e,t){let r,s=0,a=64,i=128;for(r=0;r<16;r+=2,s+=8,a+=8,i+=16,t+=64)8==r&&(i+=64),this.putquadrgb15(t+0,e,i+0,e[s+0],e[a+0]),this.putquadrgb15(t+4,e,i+2,e[s+1],e[a+1]),this.putquadrgb15(t+8,e,i+4,e[s+2],e[a+2]),this.putquadrgb15(t+12,e,i+6,e[s+3],e[a+3]),this.putquadrgb15(t+16,e,i+64,e[s+4],e[a+4]),this.putquadrgb15(t+20,e,i+66,e[s+5],e[a+5]),this.putquadrgb15(t+24,e,i+68,e[s+6],e[a+6]),this.putquadrgb15(t+28,e,i+70,e[s+7],e[a+7])},putquadrgb24:function(e,t,r,s,a){let i;const n=1433*s>>10,c=-351*a-728*s>>10,o=1807*a>>10,h=(2097151&e)>>>0;i=t[r+0]<<0,map8[h+0]=this.SCALERC256(i,n),map8[h+1]=this.SCALERC256(i,c),map8[h+2]=this.SCALERC256(i,o),i=t[r+1]<<0,map8[h+3]=this.SCALERC256(i,n),map8[h+4]=this.SCALERC256(i,c),map8[h+5]=this.SCALERC256(i,o),i=t[r+8]<<0,map8[h+48]=this.SCALERC256(i,n),map8[h+49]=this.SCALERC256(i,c),map8[h+50]=this.SCALERC256(i,o),i=t[r+9]<<0,map8[h+51]=this.SCALERC256(i,n),map8[h+52]=this.SCALERC256(i,c),map8[h+53]=this.SCALERC256(i,o)},yuv2rgb24:function(e,t){let r;3&t&&abort("alignment");let s=0,a=64,i=128;for(r=0;r<16;r+=2,s+=8,a+=8,i+=16,t+=96)8==r&&(i+=64),this.putquadrgb24(t+0,e,i+0,e[s+0],e[a+0]),this.putquadrgb24(t+6,e,i+2,e[s+1],e[a+1]),this.putquadrgb24(t+12,e,i+4,e[s+2],e[a+2]),this.putquadrgb24(t+18,e,i+6,e[s+3],e[a+3]),this.putquadrgb24(t+24,e,i+64,e[s+4],e[a+4]),this.putquadrgb24(t+30,e,i+66,e[s+5],e[a+5]),this.putquadrgb24(t+36,e,i+68,e[s+6],e[a+6]),this.putquadrgb24(t+42,e,i+70,e[s+7],e[a+7])}},r={r1820:0,r1824:2147745792,rl:0,STP:0,end:0,block:new Int32Array(384),rd32r1820:function(){return r.r1820},wr32r1820:function(e){r.r1820=e},rd32r1824:function(){return r.r1824},wr32r1824:function(e){2147483648&e&&(r.r1820=0,r.r1824=2147745792,psx.unsetEvent(r.event))},dmaTransferMode0201:function(e,s){e&=2097151;const a=(s>>>16)*(65535&s);switch(r.r1820>>>29){case 0:case 1:r.rl=e;break;case 2:if(t.iqtab_init(e,a<<2),1073741825!==r.r1820)return abort("unsupported quant mode");break;default:console.log("not implemented",r.r1820>>>29)}return a},dmaTransferMode0200:function(e,s){e&=2097151;const a=(s>>>16)*(65535&s);clearCodeCache(e,a<<2);const i=r.block,n=e+(a<<2);r.end=n;let c=0;const o=r.r1820>>>27&3;for(r.STP=r.r1820&1<<25?32768:0;e<n;){switch(r.rl=t.rl2blk(i,r.rl),o){case 0:console.warn("unsupported depth",o),e+=128;break;case 1:console.warn("unsupported depth",o),e+=256;break;case 2:t.yuv2rgb24(i,e),e+=768;break;case 3:t.yuv2rgb15(i,e),e+=512}c+=6}const h=PSX_SPEED/9e3*(c/6);return psx.setEvent(this.event,h>>>0),a},event:null,complete:function(e,t){dma.completeDMA1({}),psx.unsetEvent(e)}};for(let e=0;e<256;++e)t.scale[0+e]=0,t.scale[256+e]=e,t.scale[512+e]=255;Object.seal(t),e.mdc=Object.seal(r)})(window),(e=>{"use strict";class t extends Int32Array{getInt8(e){switch(3&e){case 0:return this[e>>2]<<24>>24;case 1:return this[e>>2]<<16>>24;case 2:return this[e>>2]<<8>>24;case 3:return this[e>>2]<<0>>24}}getInt16(e){switch(3&e){case 0:return this[e>>2]<<16>>16;case 2:return this[e>>2]<<0>>16;default:abort("unaligned read: "+hex(e))}}getInt32(e){switch(3&e){case 0:return this[e>>2]>>0;default:abort("unaligned read: "+hex(e))}}setInt8(e,t){switch(3&e){case 0:this[e>>2]=4294967040&this[e>>2]|(255&t)<<0;break;case 1:this[e>>2]=4294902015&this[e>>2]|(255&t)<<8;break;case 2:this[e>>2]=4278255615&this[e>>2]|(255&t)<<16;break;case 3:this[e>>2]=16777215&this[e>>2]|(255&t)<<24}}}const r=new t(8388608),s=new Int8Array(r.buffer),a=new Int16Array(r.buffer);e.map=r,e.map8=s,e.map16=a,e.memRead8=function(e){return e<8388608?(psx.clock+=2,s[(2097151&e)>>>0]):e>=25165824&&e<25178112?function(e){switch(psx.clock+=3,16383&e){case 4160:return joy.rd08r1040();case 4164:return joy.rd16r1044()<<24>>24;case 4180:return 0;case 4192:return s[e>>>0]>>0;case 4208:return cpu.istat<<24>>24;case 4336:return dma.rd16r10f0()<<24>>24;case 4342:return dma.rd08r10f6();case 4352:return rc0.getValue()<<24>>24;case 6144:return cdr.rd08r1800();case 6145:return cdr.rd08r1801();case 6146:return cdr.rd08r1802();case 6147:return cdr.rd08r1803();case 6164:return gpu.rd32r1814()<<24>>24;case 6180:return mdc.rd32r1824()<<24>>24;default:if(e<25169920)return psx.clock-=3,s[e>>>0];if(e>=25174016)return psx.clock+=10,s[e>>>0];if(e>=25172992&&e<25174016)return spu.getInt16(16383&e)}}(e)<<24>>24:e>=27262976&&e<27787264?(psx.clock+=5,s[e>>>0]>>0):e>=29360128&&e<29884416?(psx.clock+=8,s[e>>>0]>>0):e>=16777216&&e<17301504?(psx.clock+=6,s[e>>>0]>>0):33423664===e?s[e>>>0]>>0:void abort(`r8: unable to load from $${hex(e,8)}`)},e.memRead16=function(e){return e<8388608?(psx.clock+=3,a[(2097151&e)>>>1]):e>=25165824&&e<25178112?function(e){switch(psx.clock+=3,16383&e){case 4116:return a[e>>>1];case 4164:return joy.rd16r1044();case 4170:return joy.rd16r104a();case 4174:return joy.rd16r104e();case 4180:case 4186:case 4190:return 0;case 4192:return a[e>>>1]>>0;case 4208:return cpu.istat;case 4212:return cpu.imask;case 4336:return dma.rd16r10f0();case 4352:return rc0.getValue();case 4356:return rc0.getMode();case 4360:return rc0.getTarget();case 4368:return rc1.getValue();case 4372:return rc1.getMode();case 4376:return rc1.getTarget();case 4384:return rc2.getValue();case 4388:return rc2.getMode();case 4392:return rc2.getTarget();case 4400:return 0;case 6144:return cdr.rd08r1800();case 6164:return gpu.rd32r1814()<<16>>16;case 6180:return mdc.rd32r1824()<<16>>16;default:if(e<25169920)return psx.clock-=3,a[e>>>1];if(e>=25174016)return psx.clock+=24,a[e>>>1];if(e>=25172992&&e<25174016)return spu.getInt16(16383&e)}}(e)<<16>>16:e>=27262976&&e<27787264?(psx.clock+=5,a[e>>>1]>>0):e>=29360128&&e<29884416?(psx.clock+=12,a[e>>>1]):e>=16777216&&e<17301504?(psx.clock+=12,a[e>>>1]):33423664===e?a[e>>>1]>>0:void abort(`r16: unable to load from $${hex(e,8)}`)},e.memRead32=function(e){return e<8388608?(psx.clock+=5,r[(2097151&e)>>>2]>>0):e>=25165824&&e<25178112?function(e){switch(psx.clock+=3,16383&e){case 4116:case 4128:return r[e>>>2]>>0;case 4164:return joy.rd16r1044()>>0;case 4180:return 0;case 4192:return r[e>>>2]>>0;case 4208:return cpu.istat>>0;case 4212:return cpu.imask>>0;case 4224:return dma.r1080>>0;case 4232:return dma.r1088>>0;case 4240:return dma.r1090>>0;case 4248:return dma.r1098>>0;case 4256:return dma.r10a0>>0;case 4264:return dma.r10a8>>0;case 4272:return dma.r10b0>>0;case 4280:return dma.r10b8>>0;case 4288:return dma.r10c0>>0;case 4296:return dma.r10c8>>0;case 4320:return dma.r10e0>>0;case 4328:return dma.r10e8>>0;case 4336:return dma.rd32r10f0()>>0;case 4340:return dma.rd32r10f4()>>0;case 4352:return rc0.getValue()>>0;case 4356:return rc0.getMode()>>0;case 4360:return rc0.getTarget()>>0;case 4368:return rc1.getValue()>>0;case 4372:return rc1.getMode()>>0;case 4376:return rc1.getTarget()>>0;case 4384:return rc2.getValue()>>0;case 4388:return rc2.getMode()>>0;case 4392:return rc2.getTarget()>>0;case 6144:return cdr.rd08r1800();case 6160:return gpu.rd32r1810()>>0;case 6164:return gpu.rd32r1814()>>0;case 6176:return mdc.rd32r1820()>>0;case 6180:return mdc.rd32r1824()>>0;default:if(e<25169920)return psx.clock-=3,r[e>>>2]>>0;if(e>=25174016)return psx.clock+=56,r[e>>>2]>>0;if(e>=25172992&&e<25174016)return spu.getInt16(16383&e)}abort(`r32: unable to load from $${hex(e,8)}`)}(e)>>0:e>=27262976&&e<27787264?(psx.clock+=9,r[e>>>2]>>0):e>=29360128&&e<29884416?(psx.clock+=24,r[e>>>2]>>0):33423664===e?r[e>>>2]>>0:e>=16777216&&e<17301504?(psx.clock+=24,r[e>>>2]):void abort(`r32: unable to load from $${hex(e,8)}`)},e.memWrite8=function(e,t){if(e<8388608){const r=2097151&e;return s[(r|cpu.forceWriteBits)>>>0]=t,void(fastCache[r]=0)}return e>=25165824&&e<25174016?(s[e>>>0]=t,void(e>=25169920&&function(e,t){switch(16383&e){case 4160:return joy.wr08r1040(t);case 4342:return dma.wr08r10f6(t);case 6144:return cdr.wr08r1800(t);case 6145:return cdr.wr08r1801(t);case 6146:return cdr.wr08r1802(t);case 6147:return cdr.wr08r1803(t);default:abort(`w8: unable to store at $${hex(e,8)}`)}}(e,t))):25174081===e?s[e>>>0]=t:void abort(`w8: unable to store at $${hex(e,8)}`)},e.memWrite16=function(e,t){if(e<8388608){const r=2097151&e;return a[(r|cpu.forceWriteBits)>>>1]=t,void(fastCache[r]=0)}if(e>=25165824&&e<25174016)return a[e>>>1]=t,void(e>=25169920&&function(e,t){switch(16383&e){case 4116:return a[e>>>1]=t;case 4168:return joy.wr16r1048(t);case 4170:return joy.wr16r104a(t);case 4174:return joy.wr16r104e(t);case 4184:case 4186:case 4190:return;case 4208:return void(cpu.istat&=65535&t&cpu.imask);case 4212:return void(cpu.imask=t);case 4336:return dma.wr32r10f0(t);case 4352:return rc0.setValue(t);case 4356:return rc0.setMode(t);case 4360:return rc0.setTarget(t);case 4368:return rc1.setValue(t);case 4372:return rc1.setMode(t);case 4376:return rc1.setTarget(t);case 4384:return rc2.setValue(t);case 4388:return rc2.setMode(t);case 4392:return rc2.setTarget(t);default:if(e>=25172992&&e<25174016)return a[e>>>1]=t,spu.setInt16(16383&e,t);abort(`w16: unable to store at $${hex(e,8)}`)}}(e,t));abort(`w16: unable to store at $${hex(e,8)}`)},e.memWrite32=function(e,t){if(e<8388608){const s=2097151&e;return r[(s|cpu.forceWriteBits)>>>2]=t,void(fastCache[s]=0)}if(e>=25165824&&e<25174016)return r[e>>>2]=t,void(e>=25169920&&function(e,t){switch(16383&e){case 4096:case 4100:case 4104:case 4108:case 4112:case 4116:case 4120:case 4124:case 4128:case 4192:break;case 4208:cpu.istat&=t&cpu.imask;break;case 4212:cpu.imask=t>>>0;break;case 4224:dma.r1080=t>>>0;break;case 4228:dma.r1084=t>>>0;break;case 4232:dma.wr32r1088(t);break;case 4240:dma.r1090=t>>>0;break;case 4244:dma.r1094=t>>>0;break;case 4248:dma.wr32r1098(t);break;case 4256:dma.r10a0=t>>>0;break;case 4260:dma.r10a4=t>>>0;break;case 4264:dma.wr32r10a8(t);break;case 4272:dma.r10b0=t>>>0;break;case 4276:dma.r10b4=t>>>0;break;case 4280:dma.wr32r10b8(t);break;case 4288:dma.r10c0=t>>>0;break;case 4292:dma.r10c4=t>>>0;break;case 4296:dma.wr32r10c8(t);break;case 4320:dma.r10e0=t>>>0;break;case 4324:dma.r10e4=t>>>0;break;case 4328:dma.wr32r10e8(t);break;case 4336:dma.wr32r10f0(t);break;case 4340:dma.wr32r10f4(t);break;case 4352:rc0.setValue(t);break;case 4356:rc0.setMode(t);break;case 4360:rc0.setTarget(t);break;case 4368:rc1.setValue(t);break;case 4372:rc1.setMode(t);break;case 4376:rc1.setTarget(t);break;case 4384:rc2.setValue(t);break;case 4388:rc2.setMode(t);break;case 4392:rc2.setTarget(t);break;case 6160:gpu.wr32r1810(t);break;case 6164:gpu.wr32r1814(t);break;case 6176:mdc.wr32r1820(t);break;case 6180:mdc.wr32r1824(t);break;default:abort(`w32: unable to store at $${hex(e,8)}`)}}(e,t));33423664!==e?abort(`w32: unable to store at $${hex(e,8)}`):r[e>>>2]=t},e.MemoryBlock=t})(window),(e=>{"use strict";function t(e,t,r){const s=["  return function $"+hex(e).toUpperCase()+"(psx) { ++calls;\n    "+t.replace(/[\r\n]/g,"\n    ")+"\n  }"];return s.unshift(""),[...new Set(r||[])].forEach(e=>{s.unshift(`  const _${hex(e)} = getCacheEntry(0x${hex(e)});`)}),s.unshift("'use strict;'"),new Function(s.join("\n"))()}const r={compile02:function(e,t){e.stop=!0,e.jump=!0,e.skipNext=!0,e.branchTarget=(8388607&t)<<2;const r="j       $"+hex(e.branchTarget);return e.setReg(r,0,`target = _${hex(e.branchTarget)}`)},compile03:function(e,t){e.stop=!0,e.jump=!0,e.branchTarget=(8388607&t)<<2;const r="jal     $"+hex(e.branchTarget),s=e.setReg(r,0,`target = _${hex(e.branchTarget)};\n`+e.reg(31)+" = 0x"+hex(e.pc+8));return f.resetConst(31),s},compile04:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="beq     r"+e.rs+", r"+e.rt+", $"+hex(t,4);return e.setReg(r,0,`target = (${e.getRS()} === ${e.getRT()}) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)},compile05:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="bne     r"+e.rs+", r"+e.rt+", $"+hex(t,4);return e.setReg(r,0,`target = (${e.getRS()} !== ${e.getRT()}) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)},compile06:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="blez    r"+e.rs+", $"+hex(t,4);return e.setReg(r,0,`target = (${e.getRS()} <= 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)},compile07:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="bgtz    r"+e.rs+", $"+hex(t,4);return e.setReg(r,0,`target = (${e.getRS()} > 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)},compile08:function(e,t){const r="addi    r"+e.rt+", r"+e.rs+", $"+hex(t,4);if(f.isConst(e.rs)){const s=t<<16>>16,a=f.getConst(e.rs)+s,i=e.setReg(r,e.rt,`0x${hex(a)}`);return f.setConst(e.rt,a),i}const s=e.setReg(r,e.rt,(t<<16>>16)+" + "+e.getRS());return f.resetConst(e.rt),s},compile09:function(e,t){const r="addiu   r"+e.rt+", r"+e.rs+", $"+hex(t,4);if(f.isConst(e.rs)){const s=t<<16>>16,a=f.getConst(e.rs)+s,i=e.setReg(r,e.rt,`0x${hex(a)}`);return f.setConst(e.rt,a),i}const s=e.setReg(r,e.rt,(t<<16>>16)+" + "+e.getRS());return f.resetConst(e.rt),s},compile0A:function(e,t){const r="slti    r"+e.rt+", r"+e.rs+", $"+hex(t,4),s=e.setReg(r,e.rt,"("+e.getRS()+" < "+(t<<16>>16)+") ? 1 : 0");return f.resetConst(e.rt),s},compile0B:function(e,t){const r="sltiu   r"+e.rt+", r"+e.rs+", $"+hex(t,4),s=e.setReg(r,e.rt,"(("+e.getRS()+" >>> 0) < ("+(t<<16>>16)+" >>> 0)) ? 1 : 0");return f.resetConst(e.rt),s},compile0C:function(e,t){const r="andi    r"+e.rt+", r"+e.rs+", $"+hex(t,4);if(f.isConst(e.rs)){const s=t<<16>>>16,a=f.getConst(e.rs)&s,i=e.setReg(r,e.rt,`0x${hex(a)}`);return f.setConst(e.rt,a),i}const s=e.setReg(r,e.rt,e.getRS()+" & 0x"+hex(t,4));return f.resetConst(e.rt),s},compile0D:function(e,t){const r="ori     r"+e.rt+", r"+e.rs+", $"+hex(t,4);if(f.isConst(e.rs)){const s=t<<16>>>16,a=f.getConst(e.rs)|s,i=e.setReg(r,e.rt,`0x${hex(a)}`);return f.setConst(e.rt,a),i}const s=e.setReg(r,e.rt,e.getRS()+" | 0x"+hex(t,4));return f.resetConst(e.rt),s},compile0E:function(e,t){const r="xori    r"+e.rt+", r"+e.rs+", $"+hex(t,4);if(f.isConst(e.rs)){const s=t<<16>>>16,a=f.getConst(e.rs)^s,i=e.setReg(r,e.rt,`0x${hex(a)}`);return f.setConst(e.rt,a),i}const s=e.setReg(r,e.rt,e.getRS()+" ^ 0x"+hex(t,4));return f.resetConst(e.rt),s},compile0F:function(e,t){const r="lui     r"+e.rt+", $"+hex(t,4),s=e.setReg(r,e.rt,"0x"+hex((65535&t)<<16),!0);return f.setConst(e.rt,(65535&t)<<16),s},compile20:function(e,t){const r="lb      r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")",s=e.setReg(r,e.rt,"(memRead8("+e.getOF(t)+") << 24) >> 24");return f.resetConst(e.rt),s},compile21:function(e,t){const r="lh      r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")",s=e.setReg(r,e.rt,"(memRead16 ("+e.getOF(t)+") << 16) >> 16");return f.resetConst(e.rt),s},compile22:function(e,t){const r="lwl     r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")",s=e.setReg(r,0,"cpu.lwl("+e.rt+", "+e.getOF(t)+")");return f.resetConst(e.rt),s},compile23:function(e,t){const r="lw      r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";if(f.isConst(e.rs)){const s=t<<16>>16,a=f.getConst(e.rs)+s&33554431;if(a<=8388608){e.cycles+=5;const t=e.setReg(r,e.rt,`map[${(2097151&a)>>2}]`);return f.resetConst(e.rt),t}}const s=e.setReg(r,e.rt,"memRead32("+e.getOF(t)+")");return f.resetConst(e.rt),s},compile24:function(e,t){const r="lbu     r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";if(f.isConst(e.rs)){const s=t<<16>>16,a=f.getConst(e.rs)+s&33554431;if(a<=8388608){e.cycles+=5;const t=e.setReg(r,e.rt,`map8[0x${hex(2097151&a)}] & 0xff`);return f.resetConst(e.rt),t}}const s=e.setReg(r,e.rt,"memRead8("+e.getOF(t)+") & 0xff");return f.resetConst(e.rt),s},compile25:function(e,t){const r="lhu     r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")",s=e.setReg(r,e.rt,"memRead16("+e.getOF(t)+") & 0xffff");return f.resetConst(e.rt),s},compile26:function(e,t){const r="lwr     r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")",s=e.setReg(r,0,"cpu.lwr("+e.rt+", "+e.getOF(t)+")");return f.resetConst(e.rt),s},compile28:function(e,t){const r="sb      r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";return e.setReg(r,0,"memWrite8("+e.getOF(t)+", "+e.getRT()+")")},compile29:function(e,t){const r="sh      r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";return e.setReg(r,0,"memWrite16("+e.getOF(t)+", "+e.getRT()+")")},compile2A:function(e,t){const r="swl     r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";return e.setReg(r,0,"cpu.swl("+e.rt+", "+e.getOF(t)+")")},compile2B:function(e,t){const r="sw      r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";if(f.isConst(e.rs)){const s=t<<16>>16,a=f.getConst(e.rs)+s&33554431;if(a<=8388608){const t=e.setReg(r,0,`map[(0x${hex(2097151&a)} | cpu.forceWriteBits) >> 2] = ${e.getRT()}`);return f.resetConst(e.rt),t}}return e.setReg(r,0,`memWrite32(${e.getOF(t)}, ${e.getRT()})`)},compile2E:function(e,t){const r="swr     r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";return e.setReg(r,0,"cpu.swr("+e.rt+", "+e.getOF(t)+")")},compile32:function(e,t){const r="lwc2    r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";return e.setReg(r,0,"gte.set("+e.rt+", memRead32("+e.getOF(t)+"))")},compile3A:function(e,t){const r="swc2    r"+e.rt+", $"+hex(t,4)+"(r"+e.rs+")";return e.setReg(r,0,"memWrite32("+e.getOF(t)+", gte.get("+e.rt+"))")},compile40:function(e,t){if(0===t)return"// "+hex(e.pc)+": "+hex(t)+": nop";const r="sll     r"+e.rd+", r"+e.rt+", $"+(t>>6&31),s=e.setReg(r,e.rd,e.getRT()+" << "+(t>>6&31));return f.resetConst(e.rd),s},compile42:function(e,t){const r="srl     r"+e.rd+", r"+e.rt+", $"+(t>>6&31),s=e.setReg(r,e.rd,e.getRT()+" >>> "+(t>>6&31));return f.resetConst(e.rd),s},compile43:function(e,t){const r="sra     r"+e.rd+", r"+e.rt+", $"+(t>>6&31),s=e.setReg(r,e.rd,e.getRT()+" >> "+(t>>6&31));return f.resetConst(e.rd),s},compile44:function(e,t){const r="sllv    r"+e.rd+", r"+e.rt+", r"+e.rs,s=e.setReg(r,e.rd,e.getRT()+" << ("+e.getRS()+" & 0x1f)");return f.resetConst(e.rd),s},compile46:function(e,t){const r="srlv    r"+e.rd+", r"+e.rt+", r"+e.rs;return f.resetConst(e.rd),e.setReg(r,e.rd,e.getRT()+" >>> ("+e.getRS()+" & 0x1f)")},compile47:function(e,t){const r="srav    r"+e.rd+", r"+e.rt+", r"+e.rs,s=e.setReg(r,e.rd,e.getRT()+" >> ("+e.getRS()+" & 0x1f)");return f.resetConst(e.rd),s},compile48:function(e,t){e.stop=!0,e.jump=!0,e.skipNext=!0;const r="jr      r"+e.rs;if(f.isConst(e.rs)){return e.branchTarget=33554431&f.getConst(e.rs),e.setReg(r,0,`target = _${hex(e.branchTarget)}`)}return e.setReg(r,0,"target = getCacheEntry("+e.getRS()+")")},compile49:function(e,t){e.stop=!0,e.jump=!0;const r="jalr    r"+e.rs+", r"+e.rd,s=e.setReg(r,e.rd,"0x"+hex(e.pc+8)+";\ntarget = getCacheEntry("+e.getRS()+")");return f.resetConst(e.rd),s},compile4C:function(e,t){e.stop=!0,e.syscall=!0;return e.setReg("syscall",0,"target = cpuException(8 << 2, 0x"+hex(e.pc)+")")},compile4D:function(e,t){return"//break"},compile50:function(e,t){const r="mfhi     r"+e.rd,s=e.setReg(r,e.rd,"cpu.hi");return f.resetConst(e.rd),s},compile51:function(e,t){const r="mthi     r"+e.rs;return e.setReg(r,0,"cpu.hi = "+e.getRS())},compile52:function(e,t){const r="mflo     r"+e.rd,s=e.setReg(r,e.rd,"cpu.lo");return f.resetConst(e.rd),s},compile53:function(e,t){const r="mtlo     r"+e.rs;return e.setReg(r,0,"cpu.lo = "+e.getRS())},compile58:function(e,t){const r="mult    r"+e.rs+", r"+e.rt;return e.setReg(r,0,"cpu.mult("+e.getRS()+", "+e.getRT()+")")},compile59:function(e,t){const r="multu   r"+e.rs+", r"+e.rt;return e.setReg(r,0,"cpu.multu("+e.getRS()+", "+e.getRT()+")")},compile5A:function(e,t){const r="div     r"+e.rs+", r"+e.rt;return e.setReg(r,0,"cpu.div("+e.getRS()+", "+e.getRT()+")")},compile5B:function(e,t){const r="divu    r"+e.rs+", r"+e.rt;return e.setReg(r,0,"cpu.divu("+e.getRS()+", "+e.getRT()+")")},compile60:function(e,t){const r="add     r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=f.getConst(e.rs)+f.getConst(e.rt),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,e.getRS()+" + "+e.getRT());return f.resetConst(e.rd),s},compile61:function(e,t){const r="addu    r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=f.getConst(e.rs)+f.getConst(e.rt),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,e.getRS()+" + "+e.getRT());return f.resetConst(e.rd),s},compile62:function(e,t){const r="sub     r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=f.getConst(e.rs)-f.getConst(e.rt),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,e.getRS()+" - "+e.getRT());return f.resetConst(e.rd),s},compile63:function(e,t){const r="subu    r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=f.getConst(e.rs)-f.getConst(e.rt),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,e.getRS()+" - "+e.getRT());return f.resetConst(e.rd),s},compile64:function(e,t){const r="and     r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=f.getConst(e.rs)&f.getConst(e.rt),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,e.getRS()+" & "+e.getRT());return f.resetConst(e.rd),s},compile65:function(e,t){const r="or      r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=f.getConst(e.rs)|f.getConst(e.rt),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,e.getRS()+" | "+e.getRT());return f.resetConst(e.rd),s},compile66:function(e,t){const r="xor     r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=f.getConst(e.rs)^f.getConst(e.rt),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,e.getRS()+" ^ "+e.getRT());return f.resetConst(e.rd),s},compile67:function(e,t){const r="nor     r"+e.rd+", r"+e.rs+", r"+e.rt;if(f.isConst(e.rs)&&f.isConst(e.rt)){const t=~(f.getConst(e.rs)|f.getConst(e.rt)),s=e.setReg(r,e.rd,`0x${hex(t)}`);return f.setConst(e.rd,t),s}const s=e.setReg(r,e.rd,"~("+e.getRS()+" | "+e.getRT()+")");return f.resetConst(e.rd),s},compile6A:function(e,t){const r="slt     r"+e.rd+", r"+e.rs+", r"+e.rt,s=e.setReg(r,e.rd,"("+e.getRS()+" < "+e.getRT()+") ? 1 : 0");return f.resetConst(e.rd),s},compile6B:function(e,t){const r="sltu    r"+e.rd+", r"+e.rs+", r"+e.rt,s=e.setReg(r,e.rd,"(("+e.getRS()+" >>> 0) < ("+e.getRT()+" >>> 0)) ? 1 : 0");return f.resetConst(e.rd),s},compile80:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="bltz    r"+e.rs+", $"+hex(t,4);return e.setReg(r,0,`target = (${e.getRS()} < 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)},compile81:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="bgez    r"+e.rs+", $"+hex(t,4);return e.setReg(r,0,`target = (${e.getRS()} >= 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)},compile90:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="bltzal  r"+e.rs+", $"+hex(t,4),s=e.setReg(r,0,`target = (${e.getRS()} < 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)};\n`+e.reg(31)+" = 0x"+hex(e.pc+8));return f.resetConst(31),s},compile91:function(e,t){e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16);const r="bgezal  r"+e.rs+", $"+hex(t,4),s=e.setReg(r,0,`target = (${e.getRS()} >= 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)};\n`+e.reg(31)+" = 0x"+hex(e.pc+8));return f.resetConst(31),s},compileA0:function(e,t){const r="mfc0    r"+e.rt+", r"+e.rd,s=e.setReg(r,e.rt,"cpu.getCtrl("+e.rd+")");return f.resetConst(e.rt),s},compileA4:function(e,t){const r="mtc0    r"+e.rt+", r"+e.rd;return e.setReg(r,0,"cpu.setCtrl("+e.rd+", "+e.getRT()+")")},compileB0:function(e,t){return e.setReg("rfe",0,"cpu.rfe()")},compileC0:function(e,t){const r="mfc2    r"+e.rt+", r"+e.rd,s=e.setReg(r,e.rt,"gte.get("+e.rd+")");return f.resetConst(e.rt),s},compileC2:function(e,t){const r="cfc2    r"+e.rt+", r"+e.rd,s=e.setReg(r,e.rt,"gte.get("+(32+e.rd)+")");return f.resetConst(e.rt),s},compileC4:function(e,t){const r="mtc2    r"+e.rt+", r"+e.rd;return e.setReg(r,0,"gte.set("+e.rd+", "+e.getRT()+")")},compileC6:function(e,t){const r="ctc2    r"+e.rt+", r"+e.rd;return e.setReg(r,0,"gte.set("+(32+e.rd)+", "+e.getRT()+")")},compileD0:function(e,t){e.cycles+=gte.cycles(33554431&t);const r="cop2    0x"+hex(33554431&t);return e.setReg(r,0,"gte.command(0x"+hex(33554431&t)+")")},invalid:(e,t)=>{abort("invalid instruction")}};r.compileD1=r.compileD0,r.compileD2=r.compileD0,r.compileD3=r.compileD0,r.compileD4=r.compileD0,r.compileD5=r.compileD0,r.compileD6=r.compileD0,r.compileD7=r.compileD0,r.compileD8=r.compileD0,r.compileD9=r.compileD0,r.compileDA=r.compileD0,r.compileDB=r.compileD0,r.compileDC=r.compileD0,r.compileDD=r.compileD0,r.compileDE=r.compileD0,r.compileDF=r.compileD0;const s=new Array(256);for(let e=0;e<256;++e)s[e]=r[`compile${hex(e,2).toUpperCase()}`]||r.invalid;function a(e,t,r){const a=h(e.pc),i=map[a>>2];var n=0;switch(i>>>26&63){default:n=0+(i>>>26&63);break;case 0:n=64+(i>>>0&63);break;case 1:n=128+(i>>>16&31);break;case 16:n=160+(i>>>21&31);break;case 18:n=192+(i>>>21&31)}e.rd=i>>>11&31,e.rs=i>>>21&31,e.rt=i>>>16&31,t.push(s[n](e,i))}const i={pc:0,rt:0,rs:0,rd:0,stop:!1,break:!1,syscall:!1,cause:!1,sr:!1,cycles:0,skipNext:!1,entry:null,branchTarget:0,jump:!1,entryPC:0,reg:function(e){return e?"gpr["+e+"]":"0"},getRS:function(){if(f.isConst(this.rs)){const e=f.getConst(this.rs);return e<-127||e>127?`(0x${hex(e)}|0)`:`${e}`}return`${this.reg(this.rs)}`},getRT:function(){if(f.isConst(this.rt)){const e=f.getConst(this.rt);return e<-127||e>127?`(0x${hex(e)}|0)`:`${e}`}return`${this.reg(this.rt)}`},getOF:function(e){const t=e<<16>>16;return f.isConst(this.rs)?`0x${hex(t+f.getConst(this.rs)&33554431)}`:t?`(${t} + ${this.reg(this.rs)}) & 0x01ffffff`:`${this.reg(this.rs)} & 0x01ffffff`},setReg:function(e,t,r){const s=map[h(this.pc)>>>2];let a="// "+hex(this.pc)+": "+hex(s)+": "+e;return r&&(a+="\n"+(t?this.reg(t)+" = ":"")+`${r};`),a},clear:function(){this.branchTarget=0,this.jump=!1,this.stop=!1,this.break=!1,this.syscall=!1,this.cause=!1,this.sr=!1,this.cycles=0,this.skipNext=!1}};function n(e){const r=e.pc>>>0;let s=function(e){const t=e.pc>>>0;i.clear(),i.pc=t,i.entryPC=t,i.entry=e;const r=[];for(f.resetState();!i.stop;)a(i,r),i.cycles+=1,i.pc+=4;return!i.stop||i.break||i.syscall||i.sr||(a(i,r),i.cycles+=1,i.pc+=4),160!==t&&176!==t&&192!==t||r.unshift(`trace(${t}, gpr[9]);`),r.push("psx.clock += "+i.cycles+";"),r}(e).join("\n").split("\n");e.jump=l(i.branchTarget),e.next=i.skipNext?null:l(i.pc);let n=[i.branchTarget>>>0,i.skipNext?0:i.pc>>>0,r].filter(e=>null!==e||void 0!==e);if(s.length>=6){const e=s[0].indexOf("8fa20010");if(-1!==e&&e===s[2].indexOf("00000000")&&e===s[3].indexOf("2442ffff")&&e===s[5].indexOf("afa20010")&&e===s[7].indexOf("8fa20010")&&e===s[9].indexOf("00000000")){const e=s.filter((e,t)=>t<10&&-1!==e.indexOf("//")).join("\n");console.log(`HLE detected @$${hex(r)}...`),s.splice(0,10,["gpr[2] = --map[((16 + gpr[29]) & 0x001ffffc) >>> 2];"]),s.push("psx.clock += 10;"),s.unshift(e)}}return e.text=s.join("\n"),e.opt||(s.push("if (this.count >= 1000) {"),s.push("  CodeTrace.optimise(this);"),s.push("}")),s.push(" "),s.push("this.clock = psx.clock;"),s.push("++this.count;"),s.push(" "),s.push("return target;"),s.unshift(`const gpr = cpu.gpr; let target = _${hex(r)};\n`),r<2097152&&(s.unshift(`if (!fastCache[${r}]) { return invalidateCache(this); }`),o[r]=1),t(r,s.filter(e=>e).join("\n"),n)}const c=new Map,o=new Uint8Array(2097152);function h(e){let t=33554431&e;return t<8388608&&(t&=2097151),t}o.fill(0),Object.seal(i),Object.seal(r),Object.seal(c);let u=0;function d(){if(this.loop.length){const e=new Set,r=[],s=[];for(let t=0;t<this.loop.length;++t){let a=this.loop[t];e.add(a.pc),s.push(a.text),s.push(`_${hex(a.pc)}.clock = psx.clock;`),s.push(`++_${hex(a.pc)}.count;`),s.push("");let i=t+1<this.loop.length?this.loop[t+1].pc:this.pc;s.push(`if (target !== _${hex(i)}) break;`),a.jump&&e.add(a.jump.pc),a.next&&e.add(a.next.pc),a.pc<2097152&&r.push(`if (!fastCache[${a.pc}]) { return resetCacheEntry(_${hex(this.pc)}); }\n`),s.push(""),this.code=null,o[a.pc]=1}let a=r.join("");return a+=`\nconst gpr = cpu.gpr; let target = _${hex(this.pc)};\nwhile (psx.clock < psx.eventClock) {\n`,a+=s.join("\n"),a+="\n}\nreturn target;",this.code=t(this.pc,a,[...e]),this.jump=this,this}return this.code=n(this),this}function l(e){const t=h(e);let r=c.get(t);return r||(c.set(t,r=p.createCacheEntry(t)),r.code=d),r}e.getCacheEntry=l,e.clearCodeCache=function(e,t){const r=h(e);r>=2097152||(o.fill(0,r,r+t),++u)},e.vector=null,e.fastCache=o,e.cached=c,e.invalidateCache=(e=>(e.code=d,e.count=0,e.clock=0,e.opt=!1,e)),e.resetCacheEntry=(e=>(e.code=d,e.count=0,e.clock=0,e.opt=!1,e.loop=[],e));const f={values:new Int32Array(32),state:new Int8Array(32),resetState:function(){this.state.fill(0)},isConst:function(e){return!e||this.state[e]},getConst:function(e){return e?this.values[e]:0},setConst:function(e,t){e&&(this.values[e]=t,this.state[e]=1)},resetConst:function(e){this.state[e]=0}},p={createCacheEntry:e=>Object.seal({pc:e>>>0,code:null,jump:null,next:null,count:0,clock:0,opt:!1,text:"",loop:[]})};e.CodeTrace={loop:[],history:new Array(1024),index:0,add:function(e){this.index=(this.index+1)%1024,this.history[this.index]=e},detectLoop:function(e){for(let t=1;t<=8;++t){const r=(this.index-t+1024)%1024;if(this.history[r].opt)return 0;if(!this.history[r].jump||!this.history[r].next)return 0;if(this.history[r]===e)return t}return 0},optimise:function(e){if(psx.clock-e.clock<1024){const t=CodeTrace.detectLoop(e);if(t){const r=(this.index-t+1024)%1024,s=[];for(let e=0;e<t;++e){const t=this.history[(r+e)%1024];s.push(t)}e.loop=s}}invalidateCache(e),e.opt=!0}},e.stats=e.stats||{},e.stats.top=((e=1,t=25)=>{const r=psx.clock-33868800*e,s=[...c.values()].filter(e=>e.clock>r),a=s.reduce((e,t)=>e+t.count,0);s.sort((e,t)=>t.count-e.count).slice(0,t).forEach(e=>{console.log(`$${hex(e.pc)}\t${(e.count/a).toFixed(3)}\t`,{code:e.code},`\t${e.count}`)})}),e.calls=0;const m=0===window.location.href.indexOf("file://");let g=0;psx.addEvent(0,e=>{m&&console.log(`${calls} ${(33868800/calls).toFixed(1)} ${u} ${context.counter-g}`),psx.setEvent(e,33868800),g=context.counter,u=0,calls=0})})(window),(e=>{"use strict";const t=new Float64Array(4),r=new Uint32Array(4),s=new Uint32Array(4);function a(e,a,i){const n=8&r[e]?11:12;switch(n){case 11:var c=+(s[e]+1);break;case 12:c=65536;break;default:return abort("invalid limit bit")}let o=t[e]+a;return o>=c?(i&&i(),r[e]|=1<<n,o%c):o}t.fill(0),r.fill(0),s.fill(65535);const i={freerun:!1,getValue:function(e){const t=this.freerun;let s=0;switch(7&r[0]){case 0:s=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:s=0;break;case 0:s=+(psx.clock-o.dispHStart);break;case 1:s=+(o.dispHStop-o.dispHStart)}break;case 3:switch(o.whereInScanLine()){case-1:case 0:s=+(psx.clock-o.start);break;case 1:s=+(psx.clock-o.dispHStop)}break;case 5:switch(o.whereInScanLine()){case-1:s=+(psx.clock-o.start);break;case 0:s=+(o.dispHStart-o.start);break;case 1:s=+(psx.clock-o.dispHStop)}break;case 7:switch(o.whereInScanLine()){case-1:case 0:s=t?+(psx.clock-o.start):0;break;case 1:s=t?+(psx.clock-o.start):+(psx.clock-o.dispHStop)}break;default:return abort(`RC0: invalid mode: $${hex(r[0],4)}`)}return 256&r[0]?a(0,+gpu.cyclesToDotClock(s)):a(0,+s)},getTarget:function(e){return s[0]},getMode:function(){let e=r[0];return r[0]&=59391,e},setMode:function(e){r[0]=1023&e|1024;let s=0;switch(7&e){case 0:s=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:s=0;break;case 0:s=+(psx.clock-o.dispHStart);break;case 1:s=0}break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:s=0;break;case 1:s=+(psx.clock-o.dispHStop)}break;case 7:this.freerun=!1,s=0;break;default:return abort(`RC0: invalid mode: $${hex(r[0],4)}`)}256&r[0]?(t[0]=0,a(0,-gpu.cyclesToDotClock(s))):(t[0]=0,a(0,-s))},setTarget:function(e){e||(e=65535),s[0]=e},setValue:function(e){if(e)return abort("not supported");t[0]=e},onLimitReached:function(){48&r[0]&&(cpu.istat|=16)},onScanLine:function(){const e=this.freerun;let s=0;switch(7&r[0]){case 0:s=+(o.stop-o.start);break;case 1:s=+(o.dispHStop-o.dispHStart);break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:s=0;break;case 1:s=-+(psx.clock-o.dispHStop)}break;case 7:s=e?+(o.stop-o.start):+(o.stop-o.dispHStop),this.freerun=!0;break;default:return abort(`RC1: invalid mode: $${hex(r[0],4)}`)}256&r[0]?t[0]=a(0,gpu.cyclesToDotClock(s),this.onLimitReached):t[0]=a(0,s,this.onLimitReached)}},n={freerun:!1,getValue:function(e){o.isInVBlank();switch(263&r[1]){case 0:return a(1,+(psx.clock-o.start));case 1:return a(1,o.isInVBlank()?0:+psx.eventCycles(o.event));case 3:return a(1,+psx.eventCycles(o.event));case 5:return a(1,(o.isInVBlank(),0));case 7:return this.freerun?a(1,+psx.eventCycles(o.event)):a(1,0);case 256:case 257:case 259:case 261:return a(1,0);case 263:return this.freerun,a(1,0);default:return abort(`RC1: invalid mode: $${hex(r[1],4)}`)}},getTarget:function(e){return s[1]},getMode:function(){let e=r[1];return r[1]&=59391,e},setMode:function(e){switch(r[1]=(319&e|1024)>>>0,263&r[1]){case 0:case 1:case 3:case 5:t[1]=-+(psx.clock-o.start),t[1]=a(1,0);break;case 7:this.freerun=!1,t[1]=0;break;case 256:case 257:case 259:case 261:t[1]=0;break;case 263:this.freerun=!1,t[1]=0;break;default:return abort(`RC1: invalid mode: $${hex(r[1],4)}`)}},setTarget:function(e){e||(e=65535),s[1]=e>>>0},setValue:function(e){if(e)return abort("not supported");t[1]=+e},onLimitReached:function(){48&r[1]&&(cpu.istat|=32)},onScanLine:function(e){const s=+(o.stop-o.start);switch(263&r[1]){case 0:t[1]=a(1,s,this.onLimitReached);break;case 1:t[1]=a(1,o.isInVBlank()?0:s,this.onLimitReached);break;case 3:t[1]=a(1,s,this.onLimitReached),e&&(t[1]=0);break;case 5:t[1]=a(1,o.isInVBlank()?s:0,this.onLimitReached),o.isInVBlank()&&(t[1]=0);break;case 7:this.freerun?t[1]=a(1,s,this.onLimitReached):(t[1]=a(1,0,this.onLimitReached),e&&(this.freerun=!0));break;case 256:t[1]=a(1,1,this.onLimitReached);break;case 257:t[1]=a(1,o.isInVBlank()?0:1,this.onLimitReached);break;case 259:t[1]=a(1,1,this.onLimitReached),e&&(t[1]=0);break;case 261:t[1]=a(1,o.isInVBlank()?0:1,this.onLimitReached),e&&(t[1]=0);break;case 263:this.freerun?t[1]=a(1,1,this.onLimitReached):(t[1]=a(1,0,this.onLimitReached),e&&(this.freerun=!0));break;default:return abort(`RC1: invalid mode: $${hex(r[1],4)}`)}}},c={getValue:function(e){switch(519&r[2]){case 0:case 3:case 5:return a(2,+(psx.clock-o.start));case 1:case 7:return a(2,0);case 8:return a(2,+(psx.clock-o.start));case 512:return a(2,.125*+(psx.clock-o.start));default:return abort(`RC2: invalid mode: $${hex(r[2],4)}`)}},getTarget:function(e){return s[2]},getMode:function(){let e=r[2];return r[2]&=59391,e},setMode:function(e){switch(r[2]=1023&e|1024,519&r[2]){case 0:case 3:case 5:t[2]=-+(psx.clock-o.start),t[2]=a(2,0);break;case 1:case 7:t[2]=0;break;case 8:t[2]=-1*psx.eventCycles(o.event);break;case 512:t[2]=-.125*psx.eventCycles(o.event);break;default:return abort(`RC2: invalid mode: $${hex(r[2],4)}`)}},setTarget:function(e){e||(e=65535),s[2]=65535&e},setValue:function(e){if(e)return abort("not supported");t[2]=e},onLimitReached:function(){48&r[2]&&(cpu.istat|=64)},onScanLine:function(){switch(519&r[2]){case 0:case 3:case 5:t[2]=a(2,+(o.stop-o.start),this.onLimitReached);break;case 1:case 7:t[2]=a(2,0,this.onLimitReached);break;case 512:t[2]=a(2,.125*+(o.stop-o.start),this.onLimitReached);break;default:return abort(`RC2: invalid mode: $${hex(r[2],4)}`)}}},o={event:null,remainder:0,scanLine:0,vblank:!1,dispHStart:+Number.MAX_SAFE_INTEGER,dispHStop:+Number.MAX_SAFE_INTEGER,start:+Number.MAX_SAFE_INTEGER,stop:+Number.MAX_SAFE_INTEGER,upateToLastGpuState:function(e){const t=7*(gpu.status>>20&1?3406:3413)/11*(PSX_SPEED/33868800);this.start=+e.clock,this.stop=+t+this.start,this.dispHStart=this.start+7*+gpu.dispL/11,this.dispHStop=this.start+7*+gpu.dispR/11},complete:function(e,t){this.upateToLastGpuState(e);const r=gpu.status>>20&1?314:263;this.scanLine=(this.scanLine+1)%r,this.vblank=this.scanLine<gpu.dispT||this.scanLine>=gpu.dispB,i.onScanLine(),n.onScanLine(this.scanLine===gpu.dispB),c.onScanLine(),gpu.onScanLine(this.scanLine);let s=this.stop-this.start;psx.updateEvent(e,+s)},isInVBlank:function(){return this.vblank},whereInScanLine:function(){return psx.clock<this.dispHStart?-1:psx.clock<this.dispHStop?0:1}};e.rc0=Object.seal(i),e.rc1=Object.seal(n),e.rc2=Object.seal(c),e.dot=Object.seal(o)})(window),(e=>{"use strict";log=(()=>{});var t={baud:136,data:0,r1044:0,r104a:0,command:0,devices:[{id:0,lo:255,hi:255,data:new Uint8Array(131072),addr:0,checkSum:0,mode:0,response:[],received:[],initMemCard:function(){this.mode=0,this.response=[],this.received=[]},initController:function(){this.mode=0,this.response=[],this.received=[]},buildMemCardResponse:function(e){switch(this.mode=e,e){case 82:this.response.push(0,90,93,0,-1,92,-1,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(71);break;case 87:this.response.push(0,90,93,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(92),this.response.push(93),this.response.push(71);break;default:this.response.push(255)}},buildControllerResponse:function(e){switch(this.mode=e,e){case 66:this.response.push(65,90,this.lo,this.hi);break;case 67:this.response.push(255);break;default:return abort(`unknown subCommand: $${hex(e,2)}`)}},sendReceiveByte:function(e){this.response.length<=0&&console.log(`#${this.id}: reading unexpected in mode $${hex(this.mode,2)}`);let t=this.response.shift()||0;if(82===this.mode&&-1===t){let e=this.received.length;switch(!0){case 4===e:t=this.received[3];break;case 6===e:t=93;break;case 7===e:t=this.received[3],this.checkSum=t;break;case 8===e:this.addr=this.received[3]<<8|this.received[4],t=this.received[4],this.checkSum^=t;break;case e>=9&&e<137:let r=128*this.addr+e-9;t=this.data[r],this.checkSum^=t;break;case 137===e:t=255&this.checkSum}}if(87===this.mode&&-1===t){let r=this.received.length;switch(!0){case 3===r:t=this.received[3],this.checkSum=t;break;case 4===r:t=this.received[3],this.checkSum^=t,this.addr=t<<8|e;break;case r>=5&&r<133:let s=128*this.addr+r-5;t=this.data[s-1],this.data[s]=e,this.checkSum^=e;break;case 133===r:t=this.data[132];const a=Base64.encode(this.data);localStorage.setItem("card1",a)}}return this.received.push(e),255&t},hasMore:function(){return this.response.length>0}},{id:1,lo:255,hi:255,data:new Uint8Array(131072),addr:0,checkSum:0,mode:0,response:[],received:[],initMemCard:function(){this.mode=0,this.response=[],this.received=[]},initController:function(){this.mode=0,this.response=[],this.received=[]},buildMemCardResponse:function(e){switch(this.mode=e,e){case 82:this.response.push(0,90,93,0,-1,92,-1,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(71);break;case 87:this.response.push(0,90,93,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(92),this.response.push(93),this.response.push(71);break;default:this.response.push(255)}},buildControllerResponse:function(e){switch(this.mode=e,e){case 66:this.response.push(65,90,this.lo,this.hi);break;case 67:this.response.push(255);break;default:return abort(`unknown subCommand: $${hex(e,2)}`)}},sendReceiveByte:function(e){this.response.length<=0&&console.log(`#${this.id}: reading unexpected in mode $${hex(this.mode,2)}`);let t=this.response.shift()||0;if(82===this.mode&&-1===t){let e=this.received.length;switch(!0){case 4===e:t=this.received[3];break;case 6===e:t=93;break;case 7===e:t=this.received[3],this.checkSum=t;break;case 8===e:this.addr=this.received[3]<<8|this.received[4],t=this.received[4],this.checkSum^=t;break;case e>=9&&e<137:let r=128*this.addr+e-9;t=this.data[r],this.checkSum^=t;break;case 137===e:t=255&this.checkSum}}if(87===this.mode&&-1===t){let r=this.received.length;switch(!0){case 3===r:t=this.received[3],this.checkSum=t;break;case 4===r:t=this.received[3],this.checkSum^=t,this.addr=t<<8|e;break;case r>=5&&r<133:let s=128*this.addr+r-5;t=this.data[s-1],this.data[s]=e,this.checkSum^=e;break;case 133===r:t=this.data[132];const a=Base64.encode(this.data);localStorage.setItem("card2",a)}}return this.received.push(e),255&t},hasMore:function(){return this.response.length>0}}],rd08r1040:function(){return 2&this.r1044&&(this.r1044&=-3),this.data},rd16r1044:function(){return this.r1044},rd16r104a:function(){return this.r104a},rd16r104e:function(){return this.baud},wr08r1040:function(e){let t=null;switch(0==(2&this.r104a)&&abort("should not receive byte for device null"),2==(2&this.r104a)&&(t=8192&this.r104a?this.devices[1]:this.devices[0]),this.command){case 0:if(!t)return this.setResult(255,!0);this.setResult(255,!1),this.command=255&e,129===this.command&&t.initMemCard(),1===this.command&&t.initController();break;case 1:t.buildControllerResponse(255&e),this.command=2;case 2:{let r=t.sendReceiveByte(255&e),s=t.hasMore();this.setResult(r,!s)}break;case 129:t.buildMemCardResponse(255&e),this.command=130;case 130:{let r=t.sendReceiveByte(255&e),s=t.hasMore();this.setResult(r,!s)}break;case 131:return this.setResult(255,!0);default:console.warn("unknown command state:",hex(this.command,4)," device:",t.id)}},wr16r1048:function(e){13!==e&&abort(`invalid JOY_MODE: $${hex(e,4)}`)},wr16r104a:function(e){if(this.r104a=-81&e,64&e||!(2&this.r104a)){let e=null;2==(2&this.r104a)&&(e.initController(),e.initMemCard()),psx.unsetEvent(this.eventIRQ),this.command=0,this.r1044=5}16&e&&(this.r1044&=-513)},wr16r104e:function(e){136!==e&&abort(`invalid JOY_BAUD: $${hex(e,4)}`),this.baud=65535&e},setResult:function(e,t){this.r1044|=2,this.data=255&e,t||psx.setEvent(this.eventIRQ,8*this.baud>>>0)},eventIRQ:null,completeIRQ:function(e,t){this.r1044|=512,cpu.istat|=128,psx.unsetEvent(e)}};e.joy=Object.seal(t)})(window),(e=>{const t=22050;let r=null,s=null;var a={totalSamples:0,voices:[],index:0,writeIndex:5512,data:new Uint8Array(524288),ENDX:16777215,SPUCNT:0,SPUSTAT:0,SPUSTATm:0,mainVolumeLeft:0,mainVolumeRight:0,reverbVolumeLeft:0,reverbVolumeRight:0,cdVolumeLeft:0,cdVolumeRight:0,extVolumeLeft:0,extVolumeRight:0,irqOffset:0,ramOffset:0,reverbOffset:0,silence:function(){if(r&&s)for(var e=0;e<t;++e)r[e]=s[e]=0},getVolume:function(e){return(e<<17>>16)/32768},getInt16:function(e){switch(e){case 7594:return this.SPUCNT;case 7598:return this.SPUSTAT;case 7580:return this.ENDX;default:if(e>=7168&&e<7552){const t=e-7168>>4;return this.voices[t].getRegister(e)}return map16[(25165824+e&33554431)>>>1]}},setInt16:function(e,a){switch(a&=65535,e){case 7552:this.mainVolumeLeft=this.getVolume(a);break;case 7554:this.mainVolumeRight=this.getVolume(a);break;case 7556:this.reverbVolumeLeft=this.getVolume(a);break;case 7558:this.reverbVolumeRight=this.getVolume(a);break;case 7560:for(var i=0;i<16;++i)0!=(a&1<<i)&&(this.voices[i].keyOn(),this.ENDX&=~(1<<i));break;case 7562:for(i=0;i<8;++i)0!=(a&1<<i)&&(this.voices[16+i].keyOn(),this.ENDX&=~(1<<16+i));break;case 7564:for(i=0;i<16;++i)0!=(a&1<<i)&&this.voices[i].keyOff();break;case 7566:for(i=0;i<8;++i)0!=(a&1<<i)&&this.voices[16+i].keyOff();break;case 7568:for(i=0;i<16;++i)0!=(a&1<<i)&&this.voices[i].modOn();break;case 7570:for(i=0;i<8;++i)0!=(a&1<<i)&&this.voices[16+i].modOn();break;case 7572:for(i=0;i<16;++i)0!=(a&1<<i)&&this.voices[i].noiseOn();break;case 7574:for(i=0;i<8;++i)0!=(a&1<<i)&&this.voices[16+i].noiseOn();break;case 7576:for(i=0;i<16;++i)0!=(a&1<<i)&&this.voices[i].echoOn();break;case 7578:for(i=0;i<8;++i)0!=(a&1<<i)&&this.voices[16+i].echoOn();break;case 7580:case 7582:case 7584:break;case 7586:this.reverbOffset=a<<3;break;case 7588:this.irqOffset=a<<3;break;case 7590:this.ramOffset=a<<3;break;case 7592:this.data[this.ramOffset+0]=a>>0&255,this.data[this.ramOffset+1]=a>>8&255,this.ramOffset+=2,this.checkIrq();break;case 7596:break;case 7594:this.SPUCNT=a,r&&s||!(32768&this.SPUCNT)||function(){const e=new AudioContext,a=e.createBuffer(2,t,e.sampleRate),i=e.createBufferSource();(r=a.getChannelData(0)).fill(0),(s=a.getChannelData(1)).fill(0),i.playbackRate.value=44100/e.sampleRate,i.buffer=a,i.loop=!0,i.connect(e.destination),i.start()}(),64&this.SPUCNT&&(this.SPUSTAT&=-65),this.SPUSTATm=63&this.SPUCNT;break;case 7598:break;case 7600:this.cdVolumeLeft=a/32768;break;case 7602:this.cdVolumeRight=a/32768;break;case 7604:this.extVolumeLeft=a/32768;break;case 7606:this.extVolumeRight=a/32768;break;case 7608:case 7610:case 7612:case 7614:break;default:if(e>=7168&&e<7552){var n=(e-7168)/16|0;this.voices[n].setRegister(e,a);break}if(e>=7616&&e<7680){this.setReverbRegister(e,a);break}abort("Unimplemented spu register:"+hex(e,4))}},dmaTransferMode0200:function(e,t){var r=(t>>16)*(65535&t)*4>>>0;for(clearCodeCache(e,r);r>0;){var s=0;s|=this.data[this.ramOffset+0]>>>0<<0,s|=this.data[this.ramOffset+1]>>>0<<8,map16[(2097151&e)>>>1]=s,this.ramOffset+=2,r-=2,e+=2}return(t>>16)*(65535&t)},dmaTransferMode0201:function(e,t){for(var r=(t>>16)*(65535&t)*4>>>0;r>0;){const t=map16[(2097151&e)>>>1];this.data[this.ramOffset+0]=t>>0&255,this.data[this.ramOffset+1]=t>>8&255,this.checkIrq(),this.ramOffset+=2,r-=2,e+=2}return(t>>16)*(65535&t)},setReverbRegister:function(e,t){},checkIrq:function(e){if(32832!=(32832&this.SPUCNT))return;const t=this.totalSamples%512<<1;var r=!1;void 0!==e?e.blockAddress<=this.irqOffset&&this.irqOffset<e.blockAddress+16&&(r=!0):(this.ramOffset===this.irqOffset&&(r=!0),t===this.irqOffset&&(r=!0)),r&&(cpu.istat|=512,this.SPUSTAT|=64)},event:function(e,a){if(psx.updateEvent(e,PSX_SPEED/44100*8),r&&s){this.SPUSTAT&=-64,this.SPUSTAT|=63&this.SPUSTATm;for(let e=8;e>0;--e){++this.totalSamples;let e=0,a=0;const n=this.totalSamples%512<<1;this.checkIrq();for(let t=23;t>=0;--t){let r=this.voices[t];if(!r.adsrState)continue;r.pitchCounter+=r.pitchStep,r.pitchCounter>=114688&&(r.pitchCounter-=114688,r.decodeBlock(),this.checkIrq(r));const s=r.pitchCounter>>>12,i=r.buffer[s],c=r.mixADSR(),o=i*c*r.volumeLeft,h=i*c*r.volumeRight;if(3===t){const e=32768*o>>>0;this.data[3072+n]=255&e,this.data[3073+n]=e>>8}if(1===t){const e=32768*o>>>0;this.data[2048+n]=255&e,this.data[2049+n]=e>>8}e+=o,a+=h}var i=[0,0];cdr.nextpcm(i);let c=i[0]*this.cdVolumeLeft,o=i[1]*this.cdVolumeRight;{const e=32768*c>>>0;this.data[0+n]=255&e,this.data[1+n]=e>>8}{const e=32768*o>>>0;this.data[1024+n]=255&e,this.data[1025+n]=e>>8}e+=c,a+=o,e*=this.mainVolumeLeft,a*=this.mainVolumeRight,r[this.writeIndex]=Math.max(Math.min(e,1),-1),s[this.writeIndex]=Math.max(Math.min(a,1),-1),this.writeIndex=(this.writeIndex+1)%t,0===n&&(this.SPUSTAT&=-2049),512===n&&(this.SPUSTAT|=2048)}}}};function i(e){this.id=e,this.pitchCounter=0,this.repeatAddress=0,this.blockAddress=0,this.s0=0,this.s1=0,this.buffer=new Float32Array(28),this.volumeLeft=0,this.volumeRight=0,this.pitchStep=0,this.adsrLevel=0,this.adsrState=0,this.r1Cx0=0,this.r1Cx2=0,this.r1Cx4=0,this.r1Cx6=0,this.r1Cx8=0,this.r1CxA=0,this.r1CxE=0}i.prototype.startAdsrAttack=function(){this.adsrState=1,this.adsrLevel=0},i.prototype.startAdsrRelease=function(){this.adsrState=4},i.prototype.keyOn=function(){this.s0=0,this.s1=0,this.pitchCounter=114688,this.blockAddress=this.r1Cx6<<3,this.repeatAddress=this.r1CxE<<3,this.startAdsrAttack()},i.prototype.echoOn=function(){},i.prototype.modOn=function(){},i.prototype.noiseOn=function(){},i.prototype.keyOff=function(){this.startAdsrRelease()},i.prototype.decodeBlock=function(){var e=this.blockAddress;let t=a.data[e+0],r=a.data[e+1];var s=(15&t)>>>0,i=(240&t)>>>3,n=c[i+0],h=c[i+1],u=this.s0,d=this.s1,l=0,f=this.buffer;let p;for(var m=2;m<16;++m){var g=(s<<8)+a.data[e+m]<<1;f[l++]=p=u*n+d*h+o[g+0],d=u,u=p,f[l++]=p=u*n+d*h+o[g+1],d=u,u=p}this.s0=u,this.s1=d,4==(4&r)&&(this.repeatAddress=this.blockAddress),this.blockAddress+=16,1==(1&r)&&(this.blockAddress=this.repeatAddress,a.ENDX|=1<<this.id,0==(2&r)&&(this.startAdsrRelease(),this.adsrLevel=0))},i.prototype.mixADSR=function(){switch(this.adsrState){case 0:return 0;case 1:this.adsrAttack();break;case 2:this.adsrDecay();break;case 3:this.adsrSustain();break;case 4:this.adsrRelease();break;default:abort("not implemented")}return this.adsrLevel>2147483647&&(this.adsrLevel=2147483647),this.adsrLevel<0&&(4===this.adsrState&&1!==this.id&&3!==this.id&&(this.adsrState=0),this.adsrLevel=0),(this.adsrLevel>>16)/32768},i.prototype.adsrAttack=function(){this.adsrAttackMode?this.adsrLevel<1610612736?this.adsrLevel+=u[this.adsrAttackRate-16+32]:this.adsrLevel+=u[this.adsrAttackRate-24+32]:this.adsrLevel+=u[this.adsrAttackRate-16+32],this.adsrLevel>=2147483647&&(this.adsrState=2)},i.prototype.adsrDecay=function(){if(this.adsrDecayMode)switch(this.adsrLevel>>29&7){case 0:this.adsrLevel-=u[this.adsrDecayRate-24+0+32];break;case 1:this.adsrLevel-=u[this.adsrDecayRate-24+4+32];break;case 2:this.adsrLevel-=u[this.adsrDecayRate-24+6+32];break;case 3:this.adsrLevel-=u[this.adsrDecayRate-24+8+32];break;case 4:this.adsrLevel-=u[this.adsrDecayRate-24+9+32];break;case 5:this.adsrLevel-=u[this.adsrDecayRate-24+10+32];break;case 6:this.adsrLevel-=u[this.adsrDecayRate-24+11+32];break;case 7:this.adsrLevel-=u[this.adsrDecayRate-24+12+32]}(this.adsrLevel>>28&15)<=this.adsrSustainLevel&&(this.adsrState=3)},i.prototype.adsrSustain=function(){if(this.adsrSustainMode)if(0==this.adsrSustainDirection)this.adsrLevel<1610612736?this.adsrLevel+=u[this.adsrSustainRate-16+32]:this.adsrLevel+=u[this.adsrSustainRate-24+32];else switch(this.adsrLevel>>29&7){case 0:this.adsrLevel-=u[this.adsrSustainRate-27+0+32];break;case 1:this.adsrLevel-=u[this.adsrSustainRate-27+4+32];break;case 2:this.adsrLevel-=u[this.adsrSustainRate-27+6+32];break;case 3:this.adsrLevel-=u[this.adsrSustainRate-27+8+32];break;case 4:this.adsrLevel-=u[this.adsrSustainRate-27+9+32];break;case 5:this.adsrLevel-=u[this.adsrSustainRate-27+10+32];break;case 6:this.adsrLevel-=u[this.adsrSustainRate-27+11+32];break;case 7:this.adsrLevel-=u[this.adsrSustainRate-27+12+32]}else this.adsrLevel+=this.adsrLinearSustainRate},i.prototype.adsrRelease=function(){if(this.adsrReleaseMode)switch(this.adsrLevel>>29&7){case 0:this.adsrLevel-=u[this.adsrReleaseRate-24+0+32];break;case 1:this.adsrLevel-=u[this.adsrReleaseRate-24+4+32];break;case 2:this.adsrLevel-=u[this.adsrReleaseRate-24+6+32];break;case 3:this.adsrLevel-=u[this.adsrReleaseRate-24+8+32];break;case 4:this.adsrLevel-=u[this.adsrReleaseRate-24+9+32];break;case 5:this.adsrLevel-=u[this.adsrReleaseRate-24+10+32];break;case 6:this.adsrLevel-=u[this.adsrReleaseRate-24+11+32];break;case 7:this.adsrLevel-=u[this.adsrReleaseRate-24+12+32]}else this.adsrLevel-=this.adsrLinearReleaseRate},i.prototype.getRegister=function(e,t){switch(e%16){case 0:return this.r1Cx0;case 2:return this.r1Cx2;case 4:return this.r1Cx4;case 6:return this.r1Cx6;case 8:return this.r1Cx8;case 10:return this.r1CxA;case 12:return this.adsrLevel>>>16;case 14:return this.r1CxE;default:abort(`Unimplemented spu-voice register: ${(e%16>>>0).toString(16)}`)}},i.prototype.setRegister=function(e,t){switch(e%16){case 0:this.volumeLeft=a.getVolume(t),this.r1Cx0=t;break;case 2:this.volumeRight=a.getVolume(t),this.r1Cx2=t;break;case 4:this.pitchStep=Math.min(t,16384),this.r1Cx4=t;break;case 6:this.blockAddress=t<<3,this.r1Cx6=t;break;case 8:this.adsrAttackMode=(32768&t)>>>15,this.adsrAttackRate=(32512&t)>>>8^127,this.adsrDecayMode=1,this.adsrDecayRate=((240&t)>>>4^31)<<2,this.adsrSustainLevel=(15&t)>>>0,this.r1Cx8=t;break;case 10:this.adsrSustainMode=(32768&t)>>>15,this.adsrSustainDirection=(16384&t)>>>14,this.adsrSustainRate=(8128&t)>>>6^127,this.adsrReleaseMode=(32&t)>>>5,this.adsrReleaseRate=((31&t)>>>0^31)<<2,this.r1CxA=t,this.adsrLinearReleaseRate=u[this.adsrReleaseRate-12+32],0==this.adsrSustainDirection?this.adsrLinearSustainRate=u[this.adsrSustainRate-16+32]:this.adsrLinearSustainRate=-u[this.adsrSustainRate-15+32];break;case 12:this.adsrLevel=t<<16;break;case 14:this.repeatAddress=t<<3,this.r1CxE=t;break;default:abort("Unimplemented spu-voice register",hex(e,4))}};for(var n=0;n<24;++n)a.voices[n]=new i(n);const c=new Float32Array(32);c.fill(0),c[2]=.9375,c[3]=0,c[4]=115/64,c[5]=-.8125,c[6]=98/64,c[7]=-55/64,c[8]=122/64,c[9]=-.9375;const o=new Float32Array(8192);for(let e=0;e<16;++e)for(let t=0;t<256;++t){const r=(e<<8)+t<<1;var h;32768&(h=(240&t)<<8)&&(h|=4294901760),o[r+1]=(h>>e)/32768,32768&(h=(15&t)<<12)&&(h|=4294901760),o[r+0]=(h>>e)/32768}const u=new Uint32Array(160);!function(){let e,t,r;u.fill(0),e=3,t=1,r=0;for(let s=32;s<160;++s)e<2147483647&&(e+=t,5==++r&&(r=1,t*=2)),e>2147483647&&(e=2147483647),u[s]=e}(),e.spu=a,e.xa2flt=c,e.xa2pcm=o})(window);
